import React, { useRef, useState } from "react";
import { Accordion, AccordionSummary, AccordionDetails, CircularProgress, Table, TableBody, TableCell, TableContainer, TableHead, TableRow, Paper, Typography, IconButton, Menu, MenuItem, Toolbar, TextField, Stack } from "@mui/material";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import * as Api from 'api';
import * as LaborsApi from 'api/labor'
import * as OffersApi from 'api/offer'
import * as MaterialsApi from 'api/material'
import { LaborCategoryDisplayData, LaborItemDisplayData, LaborSubcategoryDisplayData } from "../../data/labor_display_data";
import { DataGrid } from "@mui/x-data-grid";
import MoreVertIcon from '@mui/icons-material/MoreVert';
import AddToPhotosIcon from '@mui/icons-material/AddToPhotos';
import UserPageAddOfferDetailsDialog from "./UserPageAddOfferDetailsDIalog";
import { MaterialCategoryDisplayData, MaterialItemDisplayData, MaterialSubcategoryDisplayData } from "../../data/material_display_data";
import { EstimateLaborOfferDisplayData, EstimateMaterialOfferDisplayData } from "../../data/estimate_offer_display_data";
import moment from "moment";
import { LaborOfferDisplayData, MaterialOfferDisplayData } from "../../data/offer_display_data";
import ProgressIndicator from "../../tsui/ProgressIndicator";
import { UserPageOfferEditDialog } from "./UserPageOfferEditDIalog";
import SearchComponent from "../../components/SearchComponents";
import { useApiFetchMany } from "../../components/ApiDataFetch";

// ✅ Define Interface
interface AccardionItem {
    id: string;
    label: string;
    isLoading?: boolean;
    children?: AccardionItem[]; // Holds nested children
    fullCode: string;
    code: string;
    categoryFullCode: string;


    measurementUnitRepresentationSymbol?: string;
    averagePrice?: number
    laborHours?: number;

    itemFullCode?: string;
    accountName?: string;
    price?: string;
    createdDate?: Date
    updateDate?: Date
}

// ✅ Simulated API Call (Replace with real API)
const fetchData = async (parentId: string, level: number, catalogType: 'labor' | 'material') => {
    return new Promise<any[]>((resolve) => {
        if (level === 2) {
            if (catalogType === 'labor') {
                Api.requestSession<LaborsApi.ApiLaborSubcategory[]>({
                    command: `labor/fetch_subcategories`,
                    args: { categoryMongoId: parentId }
                })
                    .then(laborSubcategoriesResData => {
                        console.log('laborSubcategoriesResData', laborSubcategoriesResData)
                        // if (mounted.current) {

                        // console.log('labor subcategories: ', laborSubcategoriesResData)
                        let laborSubcategoriesData: LaborSubcategoryDisplayData[] = [];

                        for (let laborSubcat of laborSubcategoriesResData) {
                            laborSubcategoriesData.push(new LaborSubcategoryDisplayData(laborSubcat));
                        }

                        resolve(laborSubcategoriesData);
                        // console.log('laborSubcategoriesData', laborSubcategoriesData)
                        // setLaborSubcategories(laborSubcategoriesData)
                        // setProgIndic(false)

                    })
            } else if (catalogType === 'material') {
                Api.requestSession<MaterialsApi.ApiMaterialSubcategory[]>({
                    command: `material/fetch_subcategories`,
                    args: { categoryMongoId: parentId }
                })
                    .then(materialSubcategoriesResData => {
                        // if (mounted.current) {

                        // console.log('labor subcategories: ', laborSubcategoriesResData)
                        let materialSubcategoriesData: MaterialSubcategoryDisplayData[] = [];

                        for (let materialSubcat of materialSubcategoriesResData) {
                            materialSubcategoriesData.push(new MaterialSubcategoryDisplayData(materialSubcat));
                        }

                        resolve(materialSubcategoriesData);
                        // console.log('laborSubcategoriesData', materialSubcategoriesData)
                        // setLaborSubcategories(laborSubcategoriesData)
                        // setProgIndic(false)

                    })
            }
        } else if (level === 3) {
            if (catalogType === 'labor') {
                // console.log('parentId', parentId)

                Api.requestSession<LaborsApi.ApiLaborItems[]>({
                    // command: 'labor/fetch_items', //TODO
                    command: 'labor/fetch_items_with_average_price',
                    args: { subcategoryMongoId: parentId }
                })
                    .then(laborItemsResData => {
                        // if (mounted.current) {
                        // console.log('laborItemsResData', laborItemsResData)
                        // console.log('labor subcategories: ', laborSubcategoriesResData)
                        let laborItemsData: LaborItemDisplayData[] = [];

                        for (let laborItem of laborItemsResData) {
                            laborItemsData.push(new LaborItemDisplayData(laborItem));
                        }
                        console.log('laborItemsData', laborItemsData)
                        resolve(laborItemsData);
                        // console.log('laborSubcategoriesData', laborItemsData)
                        // setLaborSubcategories(laborSubcategoriesData)
                        // setProgIndic(false)

                    })

            } else if (catalogType === 'material') {
                Api.requestSession<MaterialsApi.ApiMaterialItems[]>({
                    command: 'material/fetch_items',
                    args: { subcategoryMongoId: parentId }
                })
                    .then(materialItemsResData => {
                        // if (mounted.current) {
                        // console.log('laborItemsResData', materialItemsResData)
                        // console.log('labor subcategories: ', laborSubcategoriesResData)
                        let materialItemsData: MaterialItemDisplayData[] = [];

                        for (let materialItem of materialItemsResData) {
                            materialItemsData.push(new MaterialItemDisplayData(materialItem));
                        }

                        resolve(materialItemsData);
                        // console.log('laborSubcategoriesData', materialItemsData)
                        // setLaborSubcategories(laborSubcategoriesData)
                        // setProgIndic(false)

                    })

            }
        } else if (level === 4) {

            if (catalogType === 'labor') {
                Api.requestSession<OffersApi.ApiLaborOffer[]>({
                    command: `labor/fetch_offers`,
                    args: { searchVal: 'empty', laborItemId: parentId }
                })
                    .then(laborOffersResData => {

                        let laborOffersData: LaborOfferDisplayData[] = [];

                        for (let laborOffer of laborOffersResData) {
                            laborOffersData.push(new LaborOfferDisplayData(laborOffer));
                        }

                        resolve(laborOffersData);

                    })

            } else if (catalogType === 'material') {
                Api.requestSession<OffersApi.ApiMaterialOffer[]>({
                    command: `material/fetch_offers`,
                    args: { searchVal: 'empty', laborItemId: parentId }
                })
                    .then(materialOffersResData => {

                        let materialOffersData: MaterialOfferDisplayData[] = [];

                        for (let materialOffer of materialOffersResData) {
                            materialOffersData.push(new MaterialOfferDisplayData(materialOffer));
                        }

                        resolve(materialOffersData);

                    })

            }
        }
    });
};


// ✅ Function to Find Parent and Add Children in Correct Position
const updateNestedChildren = (items: AccardionItem[], parentId: string, newChildren: AccardionItem[], isLoading: boolean): AccardionItem[] => {
    return items.map((item) => {
        if (item.id === parentId) {
            return { ...item, children: isLoading ? undefined : newChildren, isLoading }; // ✅ Direct match
        } else if (item.children) {
            return { ...item, children: updateNestedChildren(item.children, parentId, newChildren, isLoading) }; // ✅ Recursively search in children
        }
        return item;
    });
};

interface Props {
    catalogType: 'labor' | 'material'
    offerStatus: boolean;
}

// ✅ Nested Accordion Component
export default function OfferPageThreeLevelAccordion(props: Props) {
    const [items, setItems] = useState<AccardionItem[]>([]);
    const [offerItemId, setOfferItemId] = React.useState<string | null>(null);
    const mounted = React.useRef(false);
    const [dataRequested, setDataRequested] = React.useState(true);
    const [progIndic, setProgIndic] = React.useState(false);

    const [offerItemDetailsd, setOfferItemDetailsId] = React.useState<string | null>(null);
    const [offerItemName, setOfferItemName] = React.useState<string | null>(null);
    const [offerItemEditId, setOfferItemEditId] = React.useState<string | null>(null);
    const [anchorEl, setAnchorEl] = React.useState(null);
    const [offerItemArchiveId, setOfferItemArchiveId] = React.useState<string | null>(null);

    const [expandedAccordions, setExpandedAccordions] = useState<string[]>([]);


    React.useEffect(() => {
        setDataRequested(false)
    }, [props.catalogType])


    React.useEffect(() => {
        setProgIndic(true)

        mounted.current = true;
        if (!dataRequested) {
            // console.log('I am here')
            if (props.catalogType === 'labor') {
                Api.requestSession<LaborsApi.ApiLaborCategory[]>({
                    command: `labor/fetch_categories`,
                    // args: { estimateName: estimateName }
                })
                    .then(laborCategoriesResData => {
                        if (mounted.current) {

                            // console.log('labor categories: ', d)
                            let laborCategoriesData: LaborCategoryDisplayData[] = [];

                            for (let laborCat of laborCategoriesResData) {
                                laborCategoriesData.push(new LaborCategoryDisplayData(laborCat));
                            }

                            const accordionData = [] as any;

                            laborCategoriesData.forEach(chosenCategory => {
                                accordionData.push({
                                    id: chosenCategory._id,
                                    label: chosenCategory.name,
                                    code: chosenCategory.code,
                                    children: []
                                    // content: (<AdminPageSubcategory />),
                                })
                            });

                            setItems(accordionData)
                        }
                        setProgIndic(false)

                    })
                setDataRequested(true);

                return;
            } else if (props.catalogType === 'material') {
                setProgIndic(true)

                Api.requestSession<MaterialsApi.ApiMaterialCategory[]>({
                    command: `material/fetch_categories`,
                    // args: { estimateName: estimateName }
                })
                    .then(materialCategoriesResData => {
                        if (mounted.current) {

                            // console.log('labor categories: ', d)
                            let materialCategoriesData: MaterialCategoryDisplayData[] = [];

                            for (let materialCat of materialCategoriesResData) {
                                materialCategoriesData.push(new MaterialCategoryDisplayData(materialCat));
                            }

                            const accordionData = [] as any;

                            materialCategoriesData.forEach(chosenCategory => {
                                accordionData.push({
                                    id: chosenCategory._id,
                                    label: chosenCategory.name,
                                    code: chosenCategory.code,
                                    children: []
                                    // content: (<AdminPageSubcategory />),
                                })
                            });

                            setItems(accordionData)
                        }
                        setProgIndic(false)

                    })
                setDataRequested(true);

                return;
            }
        }
        return () => { mounted.current = false }
    }, [dataRequested]);



    const handleClick = (event) => {
        setAnchorEl(event.currentTarget);
    };
    const handleClose = () => {
        setAnchorEl(null);
    };
    const handleEdit = (currentOfferItemEditId: string) => {
        setOfferItemEditId(currentOfferItemEditId)
        setAnchorEl(null);
    };
    const handleArchive = (currentOfferItemEditId: string) => {
        setOfferItemArchiveId(currentOfferItemEditId)
        setAnchorEl(null);
    };

    const handleAccordionChange = (id: string, fullCode: string, level: number) => (_event: React.SyntheticEvent, isExpanded: boolean) => {
        if (isExpanded) {
            fetchChildren(id, level); // Fetch data when opening the accordion
            console.log(fullCode)
            setExpandedAccordions((prev) => [...prev, fullCode]); // Add this accordion (fullCode) to expanded state
        } else {
            // console.log(fullCode)
            if (level === 2) {
                // If closing Level 2 (Category), fully collapse everything inside (Levels 3 & 4)
                setExpandedAccordions((prev) => prev.filter((code) => !code.startsWith(fullCode))); // Collapse all sub-levels (e.g., Level 3 & Level 4)
                setItems((prevItems) => collapseChildren(prevItems, fullCode, true)); // Collapse all children inside Level 2 (Subcategories and Items)
            } else if (level === 3) {
                // If closing Level 3 (Subcategory), remove all Level 4 accordions but KEEP Level 3 open
                setExpandedAccordions((prev) => prev.filter((code) => code !== fullCode && !code.startsWith(fullCode))); // Collapse all Level 4 children of this Level 3
                setItems((prevItems) => collapseChildren(prevItems, fullCode, true)); // Collapse Level 4, but keep Level 3
            } else if (level === 4) {
                // If closing Level 4 (Item), just remove it from expandedAccordions (collapse table)
                setExpandedAccordions((prev) => prev.filter((code) => code !== fullCode));
            }
        }
    };

    // Utility function to collapse children based on fullCode
    const collapseChildren = (items: AccardionItem[], parentFullCode: string, collapseAll: boolean): AccardionItem[] => {
        return items.map((item) => {
            if (item.fullCode === parentFullCode) {
                return { ...item, children: collapseAll ? [] : item.children }; // Collapse children (reset) when closing
            } else if (item.children) {
                return {
                    ...item,
                    children: collapseChildren(item.children, parentFullCode, collapseAll), // Recursively collapse children if applicable
                };
            }
            return item;
        });
    };




    const refreshOffersData = async () => {
        if (!items) return; // If there are no items, do nothing

        // Find all expanded Level 3 items (that should have offers)
        const updatedItems = await Promise.all(
            items.map(async (category) => ({
                ...category,
                children: await Promise.all(
                    (category.children || []).map(async (subcategory) => ({
                        ...subcategory,
                        children: await Promise.all(
                            (subcategory.children || []).map(async (item) => {
                                if (expandedAccordions.includes(item.fullCode)) {
                                    const offers = await fetchData(item.id, 4, props.catalogType);
                                    return { ...item, children: offers, isLoading: false };
                                }
                                return item;
                            })
                        ),
                    }))
                ),
            }))
        );

        setItems(updatedItems);
    };



    const fetchChildren = async (parentId: string, level: number) => {
        // console.log('fetchedData items', items)
        // console.log('fetchedData parentId', parentId)

        setItems((prevItems) =>
            prevItems.map((item) =>
                item.id === parentId ? { ...item, isLoading: true } : item
            )
        );


        const fetchedData = await fetchData(parentId, level, props.catalogType);

        const newData: AccardionItem[] = [] as AccardionItem[];
        console.log('fetchedData', fetchedData)
        fetchedData.forEach((item) => {
            let itemArr: AccardionItem = {} as AccardionItem;
            itemArr.id = item._id;
            itemArr.label = item.name
            itemArr.children = [];
            itemArr.isLoading = false;
            itemArr.fullCode = item.fullCode
            itemArr.code = item.code,
                itemArr.categoryFullCode = item.categoryFullCode,
                // itemArr.cod
                itemArr.laborHours = item.laborHours
            itemArr.measurementUnitRepresentationSymbol = item.measurementUnitRepresentationSymbol
            itemArr.averagePrice = item.averagePrice
            itemArr.itemFullCode = item.itemFullCode
            itemArr.accountName = item.accountName
            itemArr.price = item.price;
            itemArr.createdDate = item.createdDate;
            itemArr.updateDate = item.updateDate;
            newData.push(itemArr);
        })

        console.log('newData', newData)
        setItems((prevItems) => updateNestedChildren(prevItems, parentId, newData, false));


    };


    // const apiData = useApiFetchMany<Api.ApiUser>({
    //     api: {
    //         command: 'pending_users/fetch',
    //     },
    // });

    // const onSearch = React.useCallback((value) => {
    //     const apiData = useApiFetchMany<Api.ApiUser>({
    //             api: {
    //                 command: 'pending_users/fetch',
    //             },
    //         });
    // }, []);

    if (progIndic) {
        return <ProgressIndicator show={progIndic} background='backdrop' />
    }


    if (props.offerStatus) {
        return (
            <>
                {items.map((item) => (
                    <Accordion key={item.id} onChange={() => fetchChildren(item.id, 2)}>
                        <AccordionSummary expandIcon={<ExpandMoreIcon />}>{item.label}</AccordionSummary>
                        <AccordionDetails>
                            {item.isLoading ? (
                                <CircularProgress size={24} />
                            ) : item.children && item.children.length > 0 ? (
                                item.children.map((child) => (
                                    child.children ? (
                                        // ✅ Level 1 & 2: Nested Accordion
                                        <Accordion key={child.id} onChange={() => fetchChildren(child.id, 3)}>
                                            <AccordionSummary expandIcon={<ExpandMoreIcon />}>{child.label}</AccordionSummary>
                                            <AccordionDetails>
                                                {child.isLoading ? (
                                                    <CircularProgress size={24} />
                                                ) : (

                                                    <DataGrid
                                                        sx={{
                                                            width: '100%',
                                                            // color: "red"
                                                        }}
                                                        columns={[
                                                            { field: 'id', headerName: 'ID', headerAlign: 'left', width: 160, disableColumnMenu:true },
                                                            { field: 'label', headerName: 'Label', headerAlign: 'left', flex: 1, disableColumnMenu:true },
                                                            { field: 'laborHours', headerName: 'Labor Hours', headerAlign: 'left', flex: 1, disableColumnMenu:true },
                                                            { field: 'measurementUnitRepresentationSymbol', headerName: 'Unit', headerAlign: 'left', flex: 1, disableColumnMenu:true },
                                                            { field: 'averagePrice', headerName: 'Average Price', headerAlign: 'left', flex: 1, disableColumnMenu:true },

                                                            {
                                                                field: 'info', type: 'actions', headerName: '', width: 20, renderCell: (cell) => {
                                                                    return <>
                                                                        <IconButton onClick={(event: React.MouseEvent<HTMLElement>) => {
                                                                            // setUserDetailsId(cell.id as string)
                                                                            // handleClick(event);

                                                                            // props.onSelected(cell.id as string);
                                                                            setOfferItemId(cell.id as string)
                                                                        }
                                                                        }
                                                                        >
                                                                            <AddToPhotosIcon />
                                                                        </IconButton>
                                                                    </>;
                                                                }
                                                            }, // width: 600 },
                                                        ]}
                                                        rows={child.children}
                                                        // autoPageSize={true}
                                                        disableRowSelectionOnClick
                                                        getRowId={row => row.id}
                                                    />
                                                )}
                                            </AccordionDetails>
                                        </Accordion>
                                    ) : null
                                ))
                            ) : (
                                <p>{t("No more data")}</p>
                            )}
                        </AccordionDetails>
                    </Accordion>
                ))}


                {offerItemId && <UserPageAddOfferDetailsDialog catalogType={props.catalogType} offerItemMongoId={offerItemId} onClose={() => setOfferItemId(null)} />}
            </>
        );
    } else {
        return (
            <>
                {/* Uncomment this section if needed */}
                {/* <Toolbar sx={{ backgroundColor: 'inherit' }}>
                <SearchComponent onSearch={onSearch} />
              </Toolbar> */}

                {/* Stack to manage accordion layout and spacing */}
                <Stack spacing={2}>
                    {items.map((item) => (
                        <Accordion
                            key={item.id}
                            expanded={expandedAccordions.includes(item.code)}
                            onChange={handleAccordionChange(item.id, item.code, 2)}
                        >
                            <AccordionSummary
                                expandIcon={<ExpandMoreIcon />}
                                sx={{
                                    display: 'flex',
                                    flexDirection: 'row-reverse',
                                    alignItems: 'center',
                                    gap: '8px',
                                    paddingLeft: '10px',
                                }}
                            >
                                {item.label}
                            </AccordionSummary>
                            <AccordionDetails
                                sx={{
                                    position: 'relative',
                                    '&::before': {
                                        content: '""',
                                        position: 'absolute',
                                        left: 20,
                                        top: 0,
                                        width: '2px',
                                        height: '100%',
                                        backgroundColor: '#000',
                                    },
                                }}
                            >
                                {item.isLoading ? (
                                    <CircularProgress size={24} />
                                ) : item.children && item.children.length > 0 ? (
                                    <Stack spacing={2} sx={{ml: 5}}>
                                        {item.children.map((child) => (
                                            child.children ? (
                                                <Accordion
                                                    sx={{ ml: 15 }}
                                                    key={child.id}
                                                    expanded={expandedAccordions.includes(child.categoryFullCode)}
                                                    onChange={handleAccordionChange(child.id, child.categoryFullCode, 3)}
                                                >
                                                    <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                                                        {child.label}
                                                    </AccordionSummary>
                                                    <AccordionDetails>
                                                        {child.isLoading ? (
                                                            <CircularProgress size={24} />
                                                        ) : (
                                                            child.children && child.children.length > 0 ? (
                                                                <Stack spacing={2}>
                                                                    {child.children.map((subChild) => (
                                                                        <Accordion
                                                                            key={subChild.id}
                                                                            expanded={expandedAccordions.includes(subChild.fullCode)}
                                                                            onChange={handleAccordionChange(subChild.id, subChild.fullCode, 4)}
                                                                        >
                                                                            <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                                                                                {subChild.label}
                                                                            </AccordionSummary>
                                                                            <AccordionDetails>
                                                                                {subChild.isLoading ? (
                                                                                    <CircularProgress size={24} />
                                                                                ) : (
                                                                                    <DataGrid
                                                                                        sx={{ width: '100%' }}
                                                                                        columns={[
                                                                                            { field: 'itemFullCode', headerName: 'ID', headerAlign: 'left', width: 160, disableColumnMenu:true },
                                                                                            { field: 'accountName', headerName: 'Company', headerAlign: 'left', flex: 1, disableColumnMenu:true },
                                                                                            { field: 'measurementUnitRepresentationSymbol', headerName: 'Unit', headerAlign: 'left', flex: 1, disableColumnMenu:true },
                                                                                            { field: 'price', headerName: 'Price', headerAlign: 'left', flex: 1, disableColumnMenu:true },
                                                                                            {
                                                                                                field: 'createdDate', type: 'dateTime', headerName: 'Uploaded', headerAlign: 'left', align: 'left', width: 200, valueFormatter: (params) =>
                                                                                                    moment(params).format('DD.MM.YYYY HH:mm'),
                                                                                                    disableColumnMenu:true
                                                                                            },
                                                                                            {
                                                                                                field: 'updateDate', type: 'dateTime', headerName: 'Edited', headerAlign: 'left', align: 'left', width: 200, valueFormatter: (params) =>
                                                                                                    moment(params).format('DD.MM.YYYY HH:mm'),
                                                                                                    disableColumnMenu:true
                                                                                            },
                                                                                            {
                                                                                                field: 'info', type: 'actions', headerName: '', width: 20, renderCell: (cell) => (
                                                                                                    <IconButton onClick={(event) => {
                                                                                                        setOfferItemDetailsId(cell.id as string);
                                                                                                        handleClick(event);
                                                                                                    }}>
                                                                                                        <MoreVertIcon />
                                                                                                    </IconButton>
                                                                                                ),
                                                                                            },
                                                                                        ]}
                                                                                        rows={subChild.children ?? []}
                                                                                        disableRowSelectionOnClick
                                                                                        getRowId={(row) => row?.id ?? crypto.randomUUID()}
                                                                                    />
                                                                                )}
                                                                            </AccordionDetails>
                                                                        </Accordion>
                                                                    ))}
                                                                </Stack>
                                                            ) : (
                                                                <Typography>{t("No more data")}</Typography>
                                                            )
                                                        )}
                                                    </AccordionDetails>
                                                </Accordion>
                                            ) : null
                                        ))}
                                    </Stack>
                                ) : (
                                    <Typography>{t("No more data")}</Typography>
                                )}
                            </AccordionDetails>
                        </Accordion>
                    ))}
                </Stack>

                {/* Edit Dialog */}
                {offerItemEditId && (
                    <UserPageOfferEditDialog
                        offerItemName={offerItemName}
                        offerType={props.catalogType}
                        offerMongoId={offerItemEditId}
                        onClose={() => {
                            setOfferItemEditId(null);
                            setOfferItemDetailsId(null);
                            setOfferItemName(null);
                        }}
                        onConfirm={refreshOffersData}
                    />
                )}

                {/* Menu for actions */}
                {offerItemDetailsd && (
                    <Menu anchorEl={anchorEl} open={Boolean(anchorEl)} onClose={handleClose}>
                        <MenuItem onClick={() => handleEdit(offerItemDetailsd)}>Edit</MenuItem>
                        <MenuItem onClick={() => handleArchive(offerItemDetailsd)}>Archive</MenuItem>
                    </Menu>
                )}
            </>
        );
    };

}
