import React, { useRef, useState } from "react";
import { Accordion, AccordionSummary, AccordionDetails, CircularProgress, Table, TableBody, TableCell, TableContainer, TableHead, TableRow, Paper, Typography, IconButton } from "@mui/material";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import * as Api from 'api';
import * as LaborsApi from 'api/labor'
import * as MaterialsApi from 'api/material'
import { LaborItemDisplayData, LaborSubcategoryDisplayData } from "../../data/labor_display_data";
import { DataGrid } from "@mui/x-data-grid";
import MoreVertIcon from '@mui/icons-material/MoreVert';
import AddToPhotosIcon from '@mui/icons-material/AddToPhotos';
import UserPageAddOfferDetailsDialog from "../../app/offers/UserPageAddOfferDetailsDIalog";
import { MaterialItemDisplayData, MaterialSubcategoryDisplayData } from "../../data/material_display_data";
import { t } from "i18next";

// âœ… Define Interface
interface AccardionItem {
    _id: string;
    label: string;
    isLoading?: boolean;
    children?: AccardionItem[]; // Holds nested children
    fullCode?: string;
    
    measurementUnitRepresentationSymbol?: string;
    averagePrice?: string
    // laborHours?: number; //ðŸ”´ TODO: this will need us in version 2 ðŸ”´
}

// âœ… Simulated API Call (Replace with real API)
const fetchData = async (parentId: string, level: number, catalogType: 'labor' | 'material') => {
    return new Promise<any[]>((resolve) => {
        if (level === 2) {
            if (catalogType === 'labor') {
                Api.requestSession<LaborsApi.ApiLaborSubcategory[]>({
                    command: `labor/fetch_subcategories`,
                    args: { categoryMongoId: parentId }
                })
                    .then(laborSubcategoriesResData => {
                        // if (mounted.current) {

                        // console.log('labor subcategories: ', laborSubcategoriesResData)
                        let laborSubcategoriesData: LaborSubcategoryDisplayData[] = [];

                        for (let laborSubcat of laborSubcategoriesResData) {
                            laborSubcategoriesData.push(new LaborSubcategoryDisplayData(laborSubcat));
                        }

                        resolve(laborSubcategoriesData);
                        console.log('laborSubcategoriesData', laborSubcategoriesData)
                        // setLaborSubcategories(laborSubcategoriesData)
                        // setProgIndic(false)

                    })
            } else if (catalogType === 'material') {
                Api.requestSession<MaterialsApi.ApiMaterialSubcategory[]>({
                    command: `material/fetch_subcategories`,
                    args: { categoryMongoId: parentId }
                })
                    .then(materialSubcategoriesResData => {
                        // if (mounted.current) {

                        // console.log('labor subcategories: ', laborSubcategoriesResData)
                        let materialSubcategoriesData: MaterialSubcategoryDisplayData[] = [];

                        for (let materialSubcat of materialSubcategoriesResData) {
                            materialSubcategoriesData.push(new MaterialSubcategoryDisplayData(materialSubcat));
                        }

                        resolve(materialSubcategoriesData);
                        console.log('laborSubcategoriesData', materialSubcategoriesData)
                        // setLaborSubcategories(laborSubcategoriesData)
                        // setProgIndic(false)

                    })
            }
        } else if (level === 3) {
            if (catalogType === 'labor') {
                // console.log('parentId', parentId)

                Api.requestSession<LaborsApi.ApiLaborItems[]>({
                    // command: 'labor/fetch_items', //TODO
                    command: 'labor/fetch_items_with_average_price',
                    args: { subcategoryMongoId: parentId }
                })
                    .then(laborItemsResData => {
                        // if (mounted.current) {
                        console.log('laborItemsResData', laborItemsResData)
                        // console.log('labor subcategories: ', laborSubcategoriesResData)
                        let laborItemsData: LaborItemDisplayData[] = [];

                        for (let laborItem of laborItemsResData) {
                            laborItemsData.push(new LaborItemDisplayData(laborItem));
                        }

                        resolve(laborItemsData);
                        // console.log('laborSubcategoriesData', laborItemsData)
                        // setLaborSubcategories(laborSubcategoriesData)
                        // setProgIndic(false)

                    })

            } else if (catalogType === 'material') {
                Api.requestSession<MaterialsApi.ApiMaterialItems[]>({
                    command: 'material/fetch_items',
                    args: { subcategoryMongoId: parentId }
                })
                    .then(materialItemsResData => {
                        // if (mounted.current) {
                        // console.log('laborItemsResData', materialItemsResData)
                        // console.log('labor subcategories: ', laborSubcategoriesResData)
                        let materialItemsData: MaterialItemDisplayData[] = [];

                        for (let materialItem of materialItemsResData) {
                            materialItemsData.push(new MaterialItemDisplayData(materialItem));
                        }

                        resolve(materialItemsData);
                        // console.log('laborSubcategoriesData', materialItemsData)
                        // setLaborSubcategories(laborSubcategoriesData)
                        // setProgIndic(false)

                    })

            }
        }
    });
};


// âœ… Function to Find Parent and Add Children in Correct Position
const updateNestedChildren = (items: AccardionItem[], parentId: string, newChildren: AccardionItem[], isLoading: boolean): AccardionItem[] => {
    return items.map((item) => {
        if (item._id === parentId) {
            return { ...item, children: isLoading ? undefined : newChildren, isLoading }; // âœ… Direct match
        } else if (item.children) {
            return { ...item, children: updateNestedChildren(item.children, parentId, newChildren, isLoading) }; // âœ… Recursively search in children
        }
        return item;
    });
};

// âœ… Nested Accordion Component
const NestedAccordion = (props: AccardionProps) => {
    const [items, setItems] = useState<AccardionItem[]>([]);
    const [offerItemId, setOfferItemId] = React.useState<string | null>(null);
    React.useEffect(() => {
        setItems(props.data);
    }, [])

    const fetchChildren = async (parentId: string, level: number) => {
        console.log('fetchedData items', items)
        console.log('fetchedData parentId', parentId)

        setItems((prevItems) =>
            prevItems.map((item) =>
                item._id === parentId ? { ...item, isLoading: true } : item
            )
        );


        const fetchedData = await fetchData(parentId, level, props.catalogType);

        const newData: AccardionItem[] = [] as AccardionItem[];

        fetchedData.forEach((item) => {
            let itemArr: AccardionItem = {} as AccardionItem;
            itemArr._id = item._id;
            itemArr.label = item.name
            itemArr.children = [];
            itemArr.isLoading = false;
            itemArr.fullCode = item.fullCode
            // itemArr.laborHours = item.laborHours //ðŸ”´ TODO: this will need us in version 2 ðŸ”´
            itemArr.measurementUnitRepresentationSymbol = item.measurementUnitRepresentationSymbol
            if (item.averagePrice) {
                itemArr.averagePrice = item.averagePrice.toFixed(0);
            }
            newData.push(itemArr);
        })

        setItems((prevItems) => updateNestedChildren(prevItems, parentId, newData, false));


    };


    if (props.offerStatus) {
        return (
            <>
                {items.map((item) => (
                    <Accordion key={item._id} onChange={() => fetchChildren(item._id, 2)}>
                        <AccordionSummary expandIcon={<ExpandMoreIcon />}>{item.label}</AccordionSummary>
                        <AccordionDetails>
                            {item.isLoading ? (
                                <CircularProgress size={24} />
                            ) : item.children && item.children.length > 0 ? (
                                item.children.map((child) => (
                                    child.children ? (
                                        // âœ… Level 1 & 2: Nested Accordion
                                        <Accordion key={child._id} onChange={() => fetchChildren(child._id, 3)}>
                                            <AccordionSummary expandIcon={<ExpandMoreIcon />}>{child.label}</AccordionSummary>
                                            <AccordionDetails>
                                                {child.isLoading ? (
                                                    <CircularProgress size={24} />
                                                ) : (

                                                    <DataGrid
                                                        sx={{
                                                            width: '100%',
                                                            // color: "red"
                                                        }}
                                                        columns={[
                                                            { field: 'id', headerName: 'ID', headerAlign: 'left', flex:0.2, disableColumnMenu:true },
                                                            { field: 'label', headerName: 'Label', headerAlign: 'left', flex: 0.5, disableColumnMenu:true },
                                                            // { field: 'laborHours', headerName: 'Labor Hours', headerAlign: 'left', flex: 1, disableColumnMenu:true }, //ðŸ”´ TODO: this will need us in version 2 ðŸ”´
                                                            { field: 'measurementUnitRepresentationSymbol', headerName: 'Unit', headerAlign: 'left', flex: 0.2, disableColumnMenu:true },
                                                            { field: 'averagePrice', headerName: 'Average Price', headerAlign: 'left', flex: 0.3, disableColumnMenu:true },

                                                            {
                                                                field: 'info', type: 'actions', headerName: '', flex:0.2, renderCell: (cell) => {
                                                                    return <>
                                                                        <IconButton onClick={(event: React.MouseEvent<HTMLElement>) => {
                                                                            // setUserDetailsId(cell.id as string)
                                                                            // handleClick(event);

                                                                            props.onSelected(cell.row._id as string);
                                                                            setOfferItemId(cell.row._id as string)
                                                                        }
                                                                        }
                                                                        >
                                                                            <AddToPhotosIcon />
                                                                        </IconButton>
                                                                    </>;
                                                                }
                                                            }, // width: 600 },
                                                        ]}
                                                        rows={child.children}
                                                        // autoPageSize={true}
                                                        disableRowSelectionOnClick
                                                        getRowId={row => row._id}
                                                    />


                                                    // // âœ… Level 3: Display as Table (No More Expansion)
                                                    // <TableContainer component={Paper}>
                                                    //     <Table>
                                                    //         <TableHead>
                                                    //             <TableRow>
                                                    //                 <TableCell>ID</TableCell>
                                                    //                 <TableCell>Label</TableCell>
                                                    //             </TableRow>
                                                    //         </TableHead>
                                                    //         <TableBody>
                                                    //             {child.children?.map((finalItem) => (
                                                    //                 <TableRow key={finalItem.id}>
                                                    //                     <TableCell>{finalItem.id}</TableCell>
                                                    //                     <TableCell>{finalItem.label}</TableCell>
                                                    //                 </TableRow>
                                                    //             ))}
                                                    //         </TableBody>
                                                    //     </Table>
                                                    // </TableContainer>
                                                )}
                                            </AccordionDetails>
                                        </Accordion>
                                    ) : null
                                ))
                            ) : (
                                <p>{t("No more data")}</p>
                            )}
                        </AccordionDetails>
                    </Accordion>
                ))}


                {offerItemId && <UserPageAddOfferDetailsDialog catalogType={props.catalogType} offerItemMongoId={offerItemId} onClose={() => setOfferItemId(null)} onConfirm={()=>{}}/>}
            </>
        );
    } else {

        return (
            <>
                {items.map((item) => (
                    <Accordion key={item._id} onChange={() => fetchChildren(item._id, 2)}>
                        <AccordionSummary expandIcon={<ExpandMoreIcon />}>{item.label}</AccordionSummary>
                        <AccordionDetails>
                            {item.isLoading ? (
                                <CircularProgress size={24} />
                            ) : item.children && item.children.length > 0 ? (
                                item.children.map((child) => (
                                    child.children ? (
                                        // âœ… Level 1 & 2: Nested Accordion
                                        <Accordion key={child._id} onChange={() => fetchChildren(child._id, 3)}>
                                            <AccordionSummary expandIcon={<ExpandMoreIcon />}>{child.label}</AccordionSummary>
                                            <AccordionDetails>
                                                {child.isLoading ? (
                                                    <CircularProgress size={24} />
                                                ) : (

                                                    <DataGrid
                                                        sx={{
                                                            width: '100%',
                                                            // color: "red"
                                                        }}
                                                        columns={[
                                                            { field: 'fullCode', headerName: t('ID'), headerAlign: 'left', flex:0.2, disableColumnMenu:true },
                                                            { field: 'label', headerName: t('Label'), headerAlign: 'left', flex: 0.6, disableColumnMenu:true },
                                                            { field: 'measurementUnitRepresentationSymbol', headerName: t('Unit'), headerAlign: 'left', flex: 0.2, disableColumnMenu:true },
                                                        ]}
                                                        rows={child.children}
                                                        // autoPageSize={true}
                                                        disableRowSelectionOnClick
                                                        getRowId={row => row._id}
                                                    />


                                                    // // âœ… Level 3: Display as Table (No More Expansion)
                                                    // <TableContainer component={Paper}>
                                                    //     <Table>
                                                    //         <TableHead>
                                                    //             <TableRow>
                                                    //                 <TableCell>ID</TableCell>
                                                    //                 <TableCell>Label</TableCell>
                                                    //             </TableRow>
                                                    //         </TableHead>
                                                    //         <TableBody>
                                                    //             {child.children?.map((finalItem) => (
                                                    //                 <TableRow key={finalItem.id}>
                                                    //                     <TableCell>{finalItem.id}</TableCell>
                                                    //                     <TableCell>{finalItem.label}</TableCell>
                                                    //                 </TableRow>
                                                    //             ))}
                                                    //         </TableBody>
                                                    //     </Table>
                                                    // </TableContainer>
                                                )}
                                            </AccordionDetails>
                                        </Accordion>
                                    ) : null
                                ))
                            ) : (
                                <p>{t("No more data")}</p>
                            )}
                        </AccordionDetails>
                    </Accordion>
                ))}


            </>
        );

        
    };
}

// âœ… Main Component (Starts NestedAccordion)
interface AccardionProps {
    data: {
        _id: string;
        label: string;
        content: React.ReactNode;
        // children: ChildData[];
        isLoading?: boolean;
    }[]
    catalogType: 'labor' | 'material'
    offerStatus: boolean;
    onSelected: (key: string) => void;
}
export default function ThreeLevelAccordion(props: AccardionProps) {
    // const ThreeLevelAccordion = () => {

    return <NestedAccordion data={props.data} catalogType={props.catalogType} offerStatus={props.offerStatus} onSelected={props.onSelected} />;
};

// export default ThreeLevelAccordion;
