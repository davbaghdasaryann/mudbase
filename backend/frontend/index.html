<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MudBase</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
      <div class="login-container">
        <h2>üîê MudBase Login</h2>
        <div id="loginAlert"></div>
        <form id="loginForm" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" required placeholder="user@example.com" />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" required placeholder="password" />
          </div>
          <button type="submit" class="btn btn-primary" id="loginBtn">Sign In</button>
        </form>
      </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h1>MudBase</h1>
        </div>
        <div class="nav-menu">
          <div class="nav-item" onclick="showPage('dashboard')" id="nav-dashboard">
            <span class="nav-item-icon">üìä</span>
            <span>Dashboard</span>
          </div>
          <div class="nav-item active" onclick="showPage('account')" id="nav-account">
            <span class="nav-item-icon">üè¢</span>
            <span>My Account</span>
          </div>
          <div class="nav-item" onclick="showPage('accounts')" id="nav-accounts">
            <span class="nav-item-icon">üë•</span>
            <span>Accounts</span>
          </div>
          <div class="nav-item" onclick="showPage('catalog')" id="nav-catalog">
            <span class="nav-item-icon">üìö</span>
            <span>Catalogs</span>
          </div>
          <div class="nav-item" onclick="showPage('estimates')" id="nav-estimates">
            <span class="nav-item-icon">üìã</span>
            <span>Estimates</span>
          </div>
          <div class="nav-item" onclick="showPage('users')" id="nav-users">
            <span class="nav-item-icon">üë§</span>
            <span>Users</span>
          </div>
        </div>
        <div class="sidebar-footer">
          <div class="user-info" id="userInfo">Loading...</div>
          <button class="btn btn-danger" onclick="handleSignOut()" style="width: 100%">
            Sign Out
          </button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <h2 id="pageTitle">Account</h2>
        </div>
        <div class="content">
          <div id="dashboardAlert"></div>

          <!-- Dashboard Page -->
          <div id="page-dashboard" class="page">
            <div class="dashboard-grid" id="dashboardStats">
              <div class="loading">Loading dashboard data...</div>
            </div>
          </div>

          <!-- Account Page -->
          <div id="page-account" class="page active">
            <div class="company-header" id="companyHeader">
              <div class="company-logo" id="companyLogo">üè¢</div>
              <div class="company-info">
                <h2 id="companyName">Loading...</h2>
              </div>
            </div>

            <div class="tabs">
              <button class="tab" onclick="showTab('labor')" id="tab-labor">My Labors</button>
              <button class="tab" onclick="showTab('material')" id="tab-material">
                My Materials
              </button>
              <button class="tab active" onclick="showTab('aboutCompany')" id="tab-aboutCompany">
                About My Company
              </button>
            </div>

            <div class="tab-content">
              <!-- My Labors Tab -->
              <div id="tab-content-labor" class="tab-pane hidden">
                <div class="loading">My Labors content (not implemented in simplified version)</div>
              </div>

              <!-- My Materials Tab -->
              <div id="tab-content-material" class="tab-pane hidden">
                <div class="loading">
                  My Materials content (not implemented in simplified version)
                </div>
              </div>

              <!-- About Company Tab -->
              <div id="tab-content-aboutCompany" class="tab-pane">
                <div id="accountInfo">
                  <div class="loading">Loading account information...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Accounts Page -->
          <div id="page-accounts" class="page">
            <div class="tabs">
              <button
                class="tab active"
                onclick="showAccountsTab('active')"
                id="tab-accounts-active"
              >
                Active
              </button>
              <button class="tab" onclick="showAccountsTab('inactive')" id="tab-accounts-inactive">
                Inactive
              </button>
            </div>
            <div class="tab-content">
              <div id="tab-content-accounts-active" class="tab-pane">
                <div class="page-toolbar">
                  <input
                    type="text"
                    id="accountsSearch"
                    placeholder="Search accounts..."
                    class="search-input"
                    onkeyup="searchAccounts()"
                  />
                </div>
                <div id="accountsTable" class="data-table">
                  <div class="loading">Loading accounts...</div>
                </div>
              </div>
              <div id="tab-content-accounts-inactive" class="tab-pane hidden">
                <div class="page-toolbar">
                  <input
                    type="text"
                    id="inactiveAccountsSearch"
                    placeholder="Search accounts..."
                    class="search-input"
                    onkeyup="searchInactiveAccounts()"
                  />
                </div>
                <div id="inactiveAccountsTable" class="data-table">
                  <div class="loading">Loading inactive accounts...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Catalog Page -->
          <div id="page-catalog" class="page">
            <div class="tabs">
              <button class="tab active" onclick="showCatalogTab('labor')" id="tab-catalog-labor">
                Labor
              </button>
              <button class="tab" onclick="showCatalogTab('material')" id="tab-catalog-material">
                Materials
              </button>
            </div>
            <div class="tab-content">
              <div id="tab-content-catalog-labor" class="tab-pane">
                <div class="page-toolbar">
                  <input
                    type="text"
                    id="catalogSearch"
                    placeholder="Search catalog..."
                    class="search-input"
                    onkeyup="searchCatalog()"
                  />
                </div>
                <div id="catalogContent" class="catalog-accordion">
                  <div class="loading">Loading labor catalog...</div>
                </div>
              </div>
              <div id="tab-content-catalog-material" class="tab-pane hidden">
                <div class="page-toolbar">
                  <input
                    type="text"
                    id="materialCatalogSearch"
                    placeholder="Search catalog..."
                    class="search-input"
                    onkeyup="searchMaterialCatalog()"
                  />
                </div>
                <div id="materialCatalogContent" class="catalog-accordion">
                  <div class="loading">Loading materials catalog...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Estimates Page -->
          <div id="page-estimates" class="page">
            <div class="content">
              <!-- Estimates Tabs -->
              <div
                class="tabs-container"
                style="border-bottom: 2px solid #e0e0e0; margin-bottom: 20px"
              >
                <div class="tabs" style="display: flex; gap: 0">
                  <button
                    class="tab active"
                    id="tab-estimates-my"
                    onclick="showEstimatesTab('my')"
                    style="
                      padding: 12px 24px;
                      border: none;
                      background: transparent;
                      cursor: pointer;
                      border-bottom: 2px solid transparent;
                      font-weight: 500;
                      color: #666;
                      transition: all 0.2s;
                    "
                  >
                    My Estimates
                  </button>
                  <button
                    class="tab"
                    id="tab-estimates-shared"
                    onclick="showEstimatesTab('shared')"
                    style="
                      padding: 12px 24px;
                      border: none;
                      background: transparent;
                      cursor: pointer;
                      border-bottom: 2px solid transparent;
                      font-weight: 500;
                      color: #666;
                      transition: all 0.2s;
                    "
                  >
                    Shared Estimates
                  </button>
                  <button
                    class="tab"
                    id="tab-estimates-offers"
                    onclick="showEstimatesTab('offers')"
                    style="
                      padding: 12px 24px;
                      border: none;
                      background: transparent;
                      cursor: pointer;
                      border-bottom: 2px solid transparent;
                      font-weight: 500;
                      color: #666;
                      transition: all 0.2s;
                    "
                  >
                    Estimate Offers
                  </button>
                </div>
              </div>

              <!-- Tab Content -->
              <div id="tab-content-estimates-my" class="tab-pane">
                <div class="page-header">
                  <input
                    type="text"
                    id="estimatesSearch"
                    placeholder="Search estimates..."
                    class="search-input"
                    onkeyup="searchEstimates()"
                  />
                  <button
                    class="btn btn-primary"
                    onclick="openCreateEstimateDialog()"
                    style="margin-left: 20px"
                  >
                    Create Estimate
                  </button>
                </div>
                <div id="estimatesTable" class="data-table">
                  <div class="loading">Loading estimates...</div>
                </div>
              </div>

              <div id="tab-content-estimates-shared" class="tab-pane hidden">
                <div class="page-header">
                  <input
                    type="text"
                    id="sharedEstimatesSearch"
                    placeholder="Search shared estimates..."
                    class="search-input"
                    onkeyup="searchSharedEstimates()"
                  />
                  <select
                    id="sharedEstimatesAccountFilter"
                    class="search-input"
                    style="margin-left: 12px; max-width: 300px"
                    onchange="onSharedEstimatesAccountFilterChange()"
                  >
                    <option value="all">All Companies</option>
                  </select>
                </div>
                <div id="sharedEstimatesTable" class="data-table">
                  <div class="loading">Loading shared estimates...</div>
                </div>
              </div>

              <div id="tab-content-estimates-offers" class="tab-pane hidden">
                <div class="page-header">
                  <input
                    type="text"
                    id="estimateOffersSearch"
                    placeholder="Search estimate offers..."
                    class="search-input"
                    onkeyup="searchEstimateOffers()"
                  />
                  <select
                    id="estimateOffersAccountFilter"
                    class="search-input"
                    style="margin-left: 12px; max-width: 300px"
                    onchange="onEstimateOffersAccountFilterChange()"
                  >
                    <option value="all">All Companies</option>
                  </select>
                </div>
                <div id="estimateOffersTable" class="data-table">
                  <div class="loading">Loading estimate offers...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Estimate Preview Modal -->
          <div
            id="estimateModal"
            class="modal hidden"
            onclick="if(event.target.id === 'estimateModal') closeEstimateModal()"
          >
            <div class="modal-backdrop" onclick="closeEstimateModal()"></div>
            <div class="modal-content modal-fullscreen" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h2 id="estimateModalTitle">Estimate</h2>
                <div class="modal-header-actions">
                  <button class="btn-icon" onclick="printEstimate()" title="Print">üñ®Ô∏è</button>
                  <button class="btn-icon" onclick="closeEstimateModal()" title="Close">‚úï</button>
                </div>
              </div>
              <div class="modal-body" id="estimateModalBody">
                <div class="loading">Loading estimate details...</div>
              </div>
            </div>
          </div>

          <!-- Confirm Delete Dialog -->
          <div
            id="confirmDeleteModal"
            class="modal hidden"
            onclick="if(event.target.id === 'confirmDeleteModal') closeConfirmDeleteModal()"
          >
            <div class="modal-backdrop" onclick="closeConfirmDeleteModal()"></div>
            <div class="modal-content modal-small" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h3>Confirm Delete</h3>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to delete this estimate? This action cannot be undone.</p>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeConfirmDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteEstimate()">Delete</button>
              </div>
            </div>
          </div>

          <!-- Materials View Modal (for viewing existing materials) -->
          <div
            id="materialsModal"
            class="materials-modal hidden"
            onclick="if(event.target.id === 'materialsModal') closeMaterialsModal()"
          >
            <div class="modal-backdrop" onclick="closeMaterialsModal()"></div>
            <div class="materials-modal-content" onclick="event.stopPropagation()">
              <div class="materials-modal-header">
                <h3 id="materialsModalTitle">Materials</h3>
                <button class="btn-icon" onclick="closeMaterialsModal()" title="Close">‚úï</button>
              </div>
              <div class="materials-modal-body" id="materialsModalBody">
                <div class="loading">Loading materials...</div>
              </div>
              <div
                class="materials-modal-footer"
                style="
                  padding: 16px;
                  border-top: 1px solid #e0e0e0;
                  display: flex;
                  justify-content: flex-end;
                  gap: 8px;
                "
              >
                <button class="btn btn-primary" onclick="openAddMaterialDialogFromMaterialsModal()">
                  ‚ûï Add Material
                </button>
                <button class="btn" onclick="closeMaterialsModal()">Close</button>
              </div>
            </div>
          </div>

          <!-- Add Material Selection Modal (hierarchy) -->
          <div
            id="addMaterialModal"
            class="modal hidden"
            onclick="handleAddMaterialModalClick(event)"
          >
            <div class="modal-backdrop" onclick="handleAddMaterialModalBackdropClick(event)"></div>
            <div class="modal-content modal-large" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h3>Add Material</h3>
                <button class="btn-icon" onclick="closeAddMaterialModal()" title="Close">‚úï</button>
              </div>
              <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 150px)">
                <div style="margin-bottom: 20px">
                  <input
                    type="text"
                    id="addMaterialSearchInput"
                    class="search-input"
                    placeholder="Search material categories..."
                    style="max-width: 400px"
                    onkeyup="searchMaterialCategoriesInDialog()"
                  />
                </div>
                <div
                  id="addMaterialCategoriesAccordion"
                  style="max-height: 600px; overflow-y: auto"
                >
                  <div class="loading">Loading material categories...</div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeAddMaterialModal()">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Material Offers Modal (show offers table before consumption norm) -->
          <div
            id="addMaterialOffersModal"
            class="modal hidden"
            onclick="if(event.target.id === 'addMaterialOffersModal') closeAddMaterialOffersModal()"
          >
            <div class="modal-backdrop" onclick="closeAddMaterialOffersModal()"></div>
            <div class="modal-content" style="max-width: 900px" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h3 id="materialOffersModalTitle">Material Offers</h3>
                <button class="btn-icon" onclick="closeAddMaterialOffersModal()" title="Close">
                  ‚úï
                </button>
              </div>
              <div class="modal-body">
                <div id="materialOffersModalBody" style="max-height: 600px; overflow-y: auto">
                  <div class="loading">Loading offers...</div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeAddMaterialOffersModal()">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Material Details Dialog (ask for consumption norm) -->
          <div
            id="addMaterialDetailsModal"
            class="modal hidden"
            onclick="if(event.target.id === 'addMaterialDetailsModal') closeAddMaterialDetailsModal()"
          >
            <div class="modal-backdrop" onclick="closeAddMaterialDetailsModal()"></div>
            <div class="modal-content modal-small" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h3>Add Material</h3>
                <button class="btn-icon" onclick="closeAddMaterialDetailsModal()" title="Close">
                  ‚úï
                </button>
              </div>
              <div class="modal-body">
                <div class="form-field">
                  <label>Material Item</label>
                  <div
                    id="selectedMaterialItemName"
                    class="readonly-cell"
                    style="padding: 8px; background: #f5f5f5; border-radius: 4px"
                  ></div>
                </div>
                <div class="form-field">
                  <label>Material consumption norm *</label>
                  <input
                    type="number"
                    id="addMaterialConsumptionNormInput"
                    class="editable-cell"
                    placeholder="Enter material consumption norm"
                    step="0.01"
                    min="0"
                    style="width: 100%"
                    onkeydown="if(event.key === 'Enter') confirmAddMaterialItem()"
                  />
                </div>
                <div class="form-field">
                  <label>Unit</label>
                  <div
                    id="selectedMaterialUnit"
                    class="readonly-cell"
                    style="padding: 8px; background: #f5f5f5; border-radius: 4px"
                  ></div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeAddMaterialDetailsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddMaterialItem()">Add</button>
              </div>
            </div>
          </div>

          <!-- Add Section Dialog -->
          <div
            id="addSectionModal"
            class="modal hidden"
            onclick="if(event.target.id === 'addSectionModal') closeAddSectionModal()"
          >
            <div class="modal-backdrop" onclick="closeAddSectionModal()"></div>
            <div class="modal-content modal-small" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h3>Add Section</h3>
              </div>
              <div class="modal-body">
                <div class="form-field">
                  <label>Section Name</label>
                  <input
                    type="text"
                    id="sectionNameInput"
                    class="editable-cell"
                    placeholder="Enter section name"
                    style="width: 100%"
                    onkeydown="if(event.key === 'Enter') confirmAddSection()"
                  />
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeAddSectionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddSection()">Add</button>
              </div>
            </div>
          </div>

          <!-- Add Subsection Dialog -->
          <div
            id="addSubsectionModal"
            class="modal hidden"
            onclick="if(event.target.id === 'addSubsectionModal') closeAddSubsectionModal()"
          >
            <div class="modal-backdrop" onclick="closeAddSubsectionModal()"></div>
            <div class="modal-content modal-small" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h3>Add Subsection</h3>
              </div>
              <div class="modal-body">
                <div class="form-field">
                  <label>Subsection Name</label>
                  <input
                    type="text"
                    id="subsectionNameInput"
                    class="editable-cell"
                    placeholder="Enter subsection name"
                    style="width: 100%"
                    onkeydown="if(event.key === 'Enter') confirmAddSubsection()"
                  />
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeAddSubsectionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddSubsection()">Add</button>
              </div>
            </div>
          </div>

          <!-- Rename Section/Subsection Dialog -->
          <div
            id="renameSectionModal"
            class="modal hidden"
            onclick="if(event.target.id === 'renameSectionModal') closeRenameSectionModal()"
          >
            <div class="modal-backdrop" onclick="closeRenameSectionModal()"></div>
            <div class="modal-content modal-small" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h3 id="renameSectionModalTitle">Rename</h3>
              </div>
              <div class="modal-body">
                <div class="form-field">
                  <label id="renameSectionModalLabel">Name</label>
                  <input
                    type="text"
                    id="renameSectionNameInput"
                    class="editable-cell"
                    placeholder="Enter name"
                    style="width: 100%"
                    onkeydown="if(event.key === 'Enter') confirmRenameSection()"
                  />
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeRenameSectionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRenameSection()">Save</button>
              </div>
            </div>
          </div>

          <!-- Add Labor Dialog -->
          <div
            id="addLaborModal"
            class="modal hidden"
            onclick="if(event.target.id === 'addLaborModal') closeAddLaborModal()"
          >
            <div class="modal-backdrop" onclick="closeAddLaborModal()"></div>
            <div
              class="modal-content"
              style="max-width: 1000px; max-height: 90vh"
              onclick="event.stopPropagation()"
            >
              <div class="modal-header">
                <h3>Add Labor Item</h3>
                <button class="btn-icon" onclick="closeAddLaborModal()" title="Close">‚úï</button>
              </div>
              <div class="modal-body" style="overflow-y: auto; max-height: calc(90vh - 150px)">
                <div style="margin-bottom: 20px">
                  <input
                    type="text"
                    id="addLaborSearchInput"
                    class="search-input"
                    placeholder="Search labor categories..."
                    style="max-width: 400px"
                    onkeyup="searchLaborCategoriesInDialog()"
                  />
                </div>
                <div id="addLaborCategoriesAccordion" style="max-height: 600px; overflow-y: auto">
                  <div class="loading">Loading labor categories...</div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeAddLaborModal()">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Add Labor Details Dialog -->
          <div
            id="addLaborDetailsModal"
            class="modal hidden"
            onclick="if(event.target.id === 'addLaborDetailsModal') closeAddLaborDetailsModal()"
          >
            <div class="modal-backdrop" onclick="closeAddLaborDetailsModal()"></div>
            <div class="modal-content modal-small" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h3>Add Labor Item</h3>
                <button class="btn-icon" onclick="closeAddLaborDetailsModal()" title="Close">
                  ‚úï
                </button>
              </div>
              <div class="modal-body">
                <div class="form-field">
                  <label>Labor Item</label>
                  <div
                    id="selectedLaborItemName"
                    class="readonly-cell"
                    style="padding: 8px; background: #f5f5f5; border-radius: 4px"
                  ></div>
                </div>
                <div class="form-field">
                  <label>Quantity *</label>
                  <input
                    type="number"
                    id="addLaborQuantityInput"
                    class="editable-cell"
                    placeholder="Enter quantity"
                    step="0.01"
                    min="0"
                    style="width: 100%"
                    onkeydown="if(event.key === 'Enter') confirmAddLaborItem()"
                  />
                </div>
                <div class="form-field">
                  <label>Unit</label>
                  <div
                    id="selectedLaborUnit"
                    class="readonly-cell"
                    style="padding: 8px; background: #f5f5f5; border-radius: 4px"
                  ></div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn" onclick="closeAddLaborDetailsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddLaborItem()">Add</button>
              </div>
            </div>
          </div>

          <!-- Users Page -->
          <div id="page-users" class="page">
            <div class="page-toolbar">
              <input
                type="text"
                id="usersSearch"
                placeholder="Search users..."
                class="search-input"
                onkeyup="searchUsers()"
              />
            </div>
            <div id="usersTable" class="data-table">
              <div class="loading">Loading users...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Load modules in dependency order -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <!-- Load page data functions before auth.js and ui.js which depend on them -->
    <script src="js/dashboard.js"></script>
    <script src="js/account-data.js"></script>
    <script src="js/accounts.js"></script>
    <script src="js/catalog.js"></script>
    <script src="js/users.js"></script>
    <!-- Load estimates.js early because auth.js calls showEstimatesTab() -->
    <script src="js/estimates.js"></script>
    <!-- Auth depends on page data functions and showEstimatesTab -->
    <script src="js/auth.js"></script>
    <!-- UI depends on auth and all page data functions -->
    <script src="js/ui.js"></script>
    <!-- Estimate-related modules that may depend on other modules -->
    <script src="js/materials.js"></script>
    <script src="js/labor.js"></script>
    <!-- Main initialization (must be last) -->
    <script src="js/main.js"></script>
  </body>
</html>
