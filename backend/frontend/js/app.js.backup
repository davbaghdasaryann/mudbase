const API_BASE = window.location.origin;
let currentUser = null;
let accountData = null;
let isAuthenticated = false;

// Initialize
window.addEventListener('DOMContentLoaded', () => {
  console.log('DOM Content Loaded');
  // Ensure initial tab state is correct
  const aboutCompanyTab = document.getElementById('tab-content-aboutCompany');
  if (aboutCompanyTab) {
    aboutCompanyTab.classList.remove('hidden');
    aboutCompanyTab.style.display = 'block';
  }
  checkSession();
});

// Also run on load as backup
window.addEventListener('load', () => {
  console.log('Window loaded');
  checkSession();
});

// Utility functions
function showAlert(message, type = 'info', containerId = 'dashboardAlert') {
  const container = document.getElementById(containerId);
  const alertClass = `alert alert-${type}`;
  container.innerHTML = `<div class="${alertClass}">${message}</div>`;
  setTimeout(() => {
    container.innerHTML = '';
  }, 5000);
}

function getBackendUrl() {
  return API_BASE;
}

// Utility function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// API Request helper
async function makeRequest(method, path, body = null, queryParams = null) {
  let url = `${getBackendUrl()}${path}`;

  // Add query parameters
  if (queryParams && Object.keys(queryParams).length > 0) {
    const params = new URLSearchParams();
    Object.keys(queryParams).forEach((key) => {
      // Allow empty strings to be passed (they're valid query param values)
      if (queryParams[key] !== null && queryParams[key] !== undefined) {
        params.append(key, String(queryParams[key]));
      }
    });
    url += '?' + params.toString();
  }

  const options = {
    method: method,
    credentials: 'include',
    headers: {
      Accept: 'application/json',
    },
  };

  if (
    body !== null &&
    body !== undefined &&
    (method === 'POST' || method === 'PUT' || method === 'PATCH')
  ) {
    options.headers['Content-Type'] = 'application/json';
    options.body = JSON.stringify(body);
  }

  const response = await fetch(url, options);

  if (!response.ok) {
    const errorText = await response.text();
    let errorData;
    try {
      errorData = JSON.parse(errorText);
    } catch {
      errorData = {message: errorText || `HTTP ${response.status}: ${response.statusText}`};
    }
    throw new Error(errorData.message || errorData.error || `Request failed: ${response.status}`);
  }

  const contentType = response.headers.get('content-type');
  if (contentType && contentType.includes('application/json')) {
    return await response.json();
  } else {
    return await response.text();
  }
}

// Authentication
async function checkSession() {
  try {
    const response = await fetch(`${getBackendUrl()}/api/auth/session`, {
      method: 'GET',
      credentials: 'include',
    });
    const data = await response.json();

    if (data && data.user) {
      currentUser = data.user;
      isAuthenticated = true;
      showMainApp();
      updateUserInfo();
      // Load data for the active page
      setTimeout(() => {
        const activePage = document.querySelector('.page.active');
        if (activePage) {
          const pageId = activePage.id.replace('page-', '');
          if (pageId === 'dashboard') {
            loadDashboard();
          } else if (pageId === 'account') {
            loadAccountData();
          } else if (pageId === 'accounts') {
            loadAccounts('active');
          } else if (pageId === 'catalog') {
            loadCatalog('labor');
          } else if (pageId === 'estimates') {
            showEstimatesTab('my');
          } else if (pageId === 'users') {
            loadUsers();
          }
        } else {
          // Default to account page
          loadAccountData();
        }
      }, 100);
    } else {
      isAuthenticated = false;
      showLogin();
    }
  } catch (error) {
    console.error('Session check error:', error);
    isAuthenticated = false;
    showLogin();
  }
}

function showMainApp() {
  const loginPage = document.getElementById('loginPage');
  const mainApp = document.getElementById('mainApp');
  if (loginPage) loginPage.style.display = 'none';
  if (mainApp) {
    mainApp.classList.remove('hidden');
    mainApp.style.display = 'flex';
    mainApp.style.visibility = 'visible';
    // Ensure content area is visible
    const contentDiv = mainApp.querySelector('.content');
    if (contentDiv) {
      contentDiv.style.display = 'block';
      contentDiv.style.visibility = 'visible';
    }
  }
}

function showLogin() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('mainApp').classList.add('hidden');
}

async function handleLogin(event) {
  event.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const loginBtn = document.getElementById('loginBtn');

  loginBtn.disabled = true;
  loginBtn.textContent = 'Signing in...';

  try {
    // Get CSRF token
    const csrfResponse = await fetch(`${getBackendUrl()}/api/auth/csrf`, {
      method: 'GET',
      credentials: 'include',
    });
    const csrfData = await csrfResponse.json();
    const csrfToken = csrfData.csrfToken;

    const formData = new URLSearchParams();
    formData.append('email', email);
    formData.append('password', password);
    formData.append('csrfToken', csrfToken);
    formData.append('redirect', 'false');
    formData.append('json', 'true');

    const response = await fetch(`${getBackendUrl()}/api/auth/callback/credentials`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        Accept: 'application/json',
      },
      credentials: 'include',
      redirect: 'manual',
      body: formData.toString(),
    });

    // Handle redirect
    if (response.status >= 300 && response.status < 400) {
      const redirectUrl = response.headers.get('Location');
      if (
        redirectUrl &&
        (redirectUrl.includes('_redirect_dummy') || redirectUrl.includes('_redirect_signin'))
      ) {
        const redirectPath = new URL(redirectUrl).pathname + new URL(redirectUrl).search;
        await fetch(`${getBackendUrl()}${redirectPath}`, {
          method: 'GET',
          credentials: 'include',
        });
      }
      await checkSession();
      if (isAuthenticated) {
        showAlert('‚úÖ Sign in successful!', 'success', 'loginAlert');
        return;
      }
    }

    // Handle JSON response
    const contentType = response.headers.get('content-type');
    const text = await response.text();
    let data = {};
    if (text && contentType && contentType.includes('application/json')) {
      data = JSON.parse(text);
    }

    if (response.ok || response.status === 200) {
      await checkSession();
      if (isAuthenticated) {
        showAlert('‚úÖ Sign in successful!', 'success', 'loginAlert');
      }
    } else {
      showAlert(
        `‚ùå Sign in failed: ${data.error || data.message || 'Unknown error'}`,
        'error',
        'loginAlert'
      );
    }
  } catch (error) {
    showAlert(`‚ùå Sign in error: ${error.message}`, 'error', 'loginAlert');
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'Sign In';
  }
}

async function handleSignOut() {
  try {
    const csrfResponse = await fetch(`${getBackendUrl()}/api/auth/csrf`, {
      method: 'GET',
      credentials: 'include',
    });
    const csrfData = await csrfResponse.json();
    const csrfToken = csrfData.csrfToken;

    const formData = new URLSearchParams();
    formData.append('csrfToken', csrfToken);

    await fetch(`${getBackendUrl()}/api/auth/signout`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        Accept: 'application/json',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      redirect: 'manual',
      body: formData.toString(),
    });

    isAuthenticated = false;
    currentUser = null;
    accountData = null;
    showLogin();
    showAlert('‚úÖ Signed out successfully', 'success', 'loginAlert');
  } catch (error) {
    console.error('Sign out error:', error);
    isAuthenticated = false;
    currentUser = null;
    accountData = null;
    showLogin();
  }
}

function updateUserInfo() {
  const userInfo = document.getElementById('userInfo');
  if (currentUser) {
    userInfo.textContent = `üë§ ${currentUser.email || currentUser.name || 'User'}`;
  } else {
    userInfo.textContent = 'Not authenticated';
  }
}

// Navigation
function showPage(page) {
  // Hide all pages and ensure they're hidden
  document.querySelectorAll('.page').forEach((p) => {
    p.classList.remove('active');
    p.style.display = 'none';
  });
  // Show selected page
  const targetPage = document.getElementById(`page-${page}`);
  if (targetPage) {
    targetPage.classList.add('active');
    targetPage.style.display = 'block';
  }

  // Update nav items
  document.querySelectorAll('.nav-item').forEach((item) => item.classList.remove('active'));
  document.getElementById(`nav-${page}`).classList.add('active');

  // Update page title
  const titles = {
    dashboard: 'Dashboard',
    account: 'My Account',
    accounts: 'Accounts',
    catalog: 'Catalogs',
    estimates: 'Estimates',
    users: 'Users',
  };
  document.getElementById('pageTitle').textContent = titles[page] || page;

  // Load page data if needed
  if (page === 'dashboard') {
    loadDashboard();
  } else if (page === 'account') {
    loadAccountData();
  } else if (page === 'accounts') {
    loadAccounts('active');
  } else if (page === 'catalog') {
    loadCatalog('labor');
  } else if (page === 'estimates') {
    showEstimatesTab('my');
  } else if (page === 'users') {
    loadUsers();
  }
}

// Accounts Tab
function showAccountsTab(tab) {
  // Hide all tabs and tab panes in accounts page
  document.querySelectorAll('#page-accounts .tab').forEach((t) => t.classList.remove('active'));
  document.querySelectorAll('#page-accounts .tab-pane').forEach((p) => {
    p.classList.add('hidden');
    p.style.display = 'none';
  });

  // Show selected tab and tab pane
  const tabButton = document.getElementById(`tab-accounts-${tab}`);
  const tabPane = document.getElementById(`tab-content-accounts-${tab}`);

  if (tabButton) tabButton.classList.add('active');
  if (tabPane) {
    tabPane.classList.remove('hidden');
    tabPane.style.display = 'block';
  }

  if (tab === 'active') {
    loadAccounts('active');
  } else {
    loadAccounts('inactive');
  }
}

async function loadAccounts(type = 'active', searchVal = null) {
  const containerId = type === 'active' ? 'accountsTable' : 'inactiveAccountsTable';
  const container = document.getElementById(containerId);
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading accounts...</div>';

    const endpoint = type === 'active' ? 'accounts/fetch_active' : 'accounts/fetch_inactive';
    const queryParams = {};
    if (searchVal) queryParams.search = searchVal;

    const response = await makeRequest('GET', `/api/v1/${endpoint}`, null, queryParams);
    const accounts = Array.isArray(response) ? response : [];

    if (accounts.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No accounts found</div>';
      return;
    }

    container.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>Company Name</th>
            <th>TIN</th>
            <th>Phone</th>
            <th>Email</th>
          </tr>
        </thead>
        <tbody>
          ${accounts
            .map(
              (account) => `
            <tr>
              <td>${escapeHtml(account.companyName || '-')}</td>
              <td>${escapeHtml(account.companyTin || '-')}</td>
              <td>${escapeHtml(account.phoneNumber || '-')}</td>
              <td>${escapeHtml(account.email || '-')}</td>
            </tr>
          `
            )
            .join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('Error loading accounts:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading accounts: ${error.message}</div>`;
  }
}

function searchAccounts() {
  const searchVal = document.getElementById('accountsSearch')?.value || '';
  loadAccounts('active', searchVal || null);
}

function searchInactiveAccounts() {
  const searchVal = document.getElementById('inactiveAccountsSearch')?.value || '';
  loadAccounts('inactive', searchVal || null);
}

// Catalog Tab
function showCatalogTab(tab) {
  // Hide all tabs and tab panes in catalog page
  document.querySelectorAll('#page-catalog .tab').forEach((t) => t.classList.remove('active'));
  document.querySelectorAll('#page-catalog .tab-pane').forEach((p) => {
    p.classList.add('hidden');
    p.style.display = 'none';
  });

  // Show selected tab and tab pane
  const tabButton = document.getElementById(`tab-catalog-${tab}`);
  const tabPane = document.getElementById(`tab-content-catalog-${tab}`);

  if (tabButton) tabButton.classList.add('active');
  if (tabPane) {
    tabPane.classList.remove('hidden');
    tabPane.style.display = 'block';
  }

  loadCatalog(tab);
}

async function loadCatalog(type = 'labor', searchVal = null) {
  const containerId = type === 'labor' ? 'catalogContent' : 'materialCatalogContent';
  const container = document.getElementById(containerId);
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading catalog...</div>';

    const endpoint = type === 'labor' ? 'labor/fetch_categories' : 'material/fetch_categories';
    const queryParams = {};
    if (searchVal) queryParams.searchVal = searchVal;

    const response = await makeRequest('GET', `/api/v1/${endpoint}`, null, queryParams);
    const categories = Array.isArray(response) ? response : [];

    if (categories.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No categories found</div>';
      return;
    }

    container.innerHTML = categories
      .map(
        (category) => `
      <div class="catalog-item">
        <div class="catalog-item-header" onclick="toggleCatalogItem(this)">
          <div>
            <span class="catalog-item-title">${escapeHtml(category.name || '-')}</span>
            ${
              category.code
                ? `<span class="catalog-item-code">(${escapeHtml(category.code)})</span>`
                : ''
            }
          </div>
          <span>${category.childrenQuantity || 0} items</span>
        </div>
        <div class="catalog-item-content" data-category-id="${category._id}" data-type="${type}">
          <div class="loading">Loading subcategories...</div>
        </div>
      </div>
    `
      )
      .join('');
  } catch (error) {
    console.error('Error loading catalog:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading catalog: ${error.message}</div>`;
  }
}

async function toggleCatalogItem(header) {
  const content = header.nextElementSibling;
  const isExpanded = content.classList.contains('expanded');

  if (isExpanded) {
    content.classList.remove('expanded');
    return;
  }

  content.classList.add('expanded');
  const categoryId = content.dataset.categoryId;
  const type = content.dataset.type;

  if (content.querySelector('.loading')) {
    try {
      const endpoint =
        type === 'labor' ? 'labor/fetch_subcategories' : 'material/fetch_subcategories';
      const response = await makeRequest('GET', `/api/v1/${endpoint}`, null, {
        categoryMongoId: categoryId,
        searchVal: '',
      });
      const subcategories = Array.isArray(response) ? response : [];

      content.innerHTML =
        subcategories.length > 0
          ? subcategories
              .map(
                (sub) => `
        <div class="catalog-item-children">
          <div><strong>${escapeHtml(sub.name || '-')}</strong> ${
                  sub.code ? `(${escapeHtml(sub.code)})` : ''
                }</div>
          ${sub.averagePrice ? `<div>Avg Price: ${sub.averagePrice}</div>` : ''}
          ${
            sub.measurementUnitRepresentationSymbol
              ? `<div>Unit: ${escapeHtml(sub.measurementUnitRepresentationSymbol)}</div>`
              : ''
          }
        </div>
      `
              )
              .join('')
          : '<div class="alert alert-info">No subcategories found</div>';
    } catch (error) {
      console.error('Error loading subcategories:', error);
      content.innerHTML = `<div class="alert alert-error">Error loading subcategories: ${error.message}</div>`;
    }
  }
}

function searchCatalog() {
  const searchVal = document.getElementById('catalogSearch')?.value || '';
  loadCatalog('labor', searchVal || null);
}

function searchMaterialCatalog() {
  const searchVal = document.getElementById('materialCatalogSearch')?.value || '';
  loadCatalog('material', searchVal || null);
}

// Estimates
let currentEstimateId = null;
let currentEstimateTitle = null;
let deleteEstimateId = null;

async function loadEstimates(searchVal = '') {
  const container = document.getElementById('estimatesTable');
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading estimates...</div>';

    const queryParams = {searchVal: searchVal || 'empty'};
    const response = await makeRequest('GET', '/api/v1/estimates/fetch', null, queryParams);
    const estimates = Array.isArray(response) ? response : [];

    if (estimates.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No estimates found</div>';
      return;
    }

    container.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Cost</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${estimates
            .map(
              (estimate) => `
            <tr ondblclick="openEstimateModal('${estimate._id}', '${escapeHtml(
                estimate.name || estimate.estimateName || 'Estimate'
              )}')">
              <td>${escapeHtml(estimate.estimateNumber || estimate._id.substring(0, 8))}</td>
              <td>${escapeHtml(estimate.name || estimate.estimateName || '-')}</td>
              <td>${
                estimate.totalCostWithOtherExpenses || estimate.totalCost || estimate.totalPrice
                  ? (
                      estimate.totalCostWithOtherExpenses ||
                      estimate.totalCost ||
                      estimate.totalPrice
                    ).toFixed(2)
                  : '0.00'
              }</td>
              <td>${
                estimate.createdAt ? new Date(estimate.createdAt).toLocaleDateString() : '-'
              }</td>
              <td>
                <div class="table-actions">
                  <button class="table-action-btn" onclick="event.stopPropagation(); openEstimateModal('${
                    estimate._id
                  }', '${escapeHtml(
                estimate.name || estimate.estimateName || 'Estimate'
              )}')" title="View/Edit">
                    üëÅÔ∏è
                  </button>
                  <button class="table-action-btn danger" onclick="event.stopPropagation(); confirmDeleteEstimateDialog('${
                    estimate._id
                  }')" title="Delete">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          `
            )
            .join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('Error loading estimates:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading estimates: ${error.message}</div>`;
  }
}

function searchEstimates() {
  const searchVal = document.getElementById('estimatesSearch')?.value || '';
  loadEstimates(searchVal || 'empty');
}

// Estimates Tabs
function showEstimatesTab(tab) {
  // Hide all tabs and tab panes in estimates page
  document.querySelectorAll('#page-estimates .tab').forEach((t) => {
    t.classList.remove('active');
    t.style.borderBottomColor = 'transparent';
    t.style.color = '#666';
    t.style.fontWeight = '500';
  });
  document.querySelectorAll('#page-estimates .tab-pane').forEach((p) => {
    p.classList.add('hidden');
    p.style.display = 'none';
  });

  // Show selected tab and tab pane
  const tabButton = document.getElementById(`tab-estimates-${tab}`);
  const tabPane = document.getElementById(`tab-content-estimates-${tab}`);

  if (tabButton) {
    tabButton.classList.add('active');
    tabButton.style.borderBottomColor = '#1976d2';
    tabButton.style.color = '#1976d2';
    tabButton.style.fontWeight = '600';
  }
  if (tabPane) {
    tabPane.classList.remove('hidden');
    tabPane.style.display = 'block';
  }

  // Load data for the selected tab
  if (tab === 'my') {
    loadEstimates();
  } else if (tab === 'shared') {
    // Load accounts filter first, then load estimates
    loadSharedEstimatesAccounts().then(() => {
      loadSharedEstimates();
    });
  } else if (tab === 'offers') {
    // Load accounts filter first, then load estimates
    loadEstimateOffersAccounts().then(() => {
      loadEstimateOffers();
    });
  }
}

// Shared Estimates Account Filter State
let sharedEstimatesAccountsList = [];
let selectedSharedEstimatesAccountId = 'all';

// Load accounts list for shared estimates filter
async function loadSharedEstimatesAccounts() {
  try {
    const accounts = await makeRequest(
      'GET',
      '/api/v1/accounts/with_estimates_shared_by_me',
      null,
      null
    );
    sharedEstimatesAccountsList = Array.isArray(accounts) ? accounts : [];

    // Update dropdown options
    const filterSelect = document.getElementById('sharedEstimatesAccountFilter');
    if (filterSelect) {
      // Clear existing options except "All"
      filterSelect.innerHTML = '<option value="all">All Companies</option>';

      // Remove duplicates based on companyName
      const uniqueAccounts = sharedEstimatesAccountsList.filter(
        (account, index, self) =>
          index === self.findIndex((a) => a.companyName === account.companyName)
      );

      // Add account options
      uniqueAccounts.forEach((account) => {
        const option = document.createElement('option');
        option.value = account._id;
        option.textContent = account.companyName || '-';
        filterSelect.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Error loading shared estimates accounts:', error);
  }
}

function onSharedEstimatesAccountFilterChange() {
  const filterSelect = document.getElementById('sharedEstimatesAccountFilter');
  if (filterSelect) {
    selectedSharedEstimatesAccountId = filterSelect.value || 'all';
    searchSharedEstimates();
  }
}

// Estimates - Shared Estimates
async function loadSharedEstimates(searchVal = '') {
  const container = document.getElementById('sharedEstimatesTable');
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading shared estimates...</div>';

    const queryParams = {searchVal: searchVal || 'empty'};
    // Pass accountId in request body (matching production API behavior - estimates_shared_by_me/fetch expects accountId in req.body)
    const requestBody =
      selectedSharedEstimatesAccountId && selectedSharedEstimatesAccountId !== 'all'
        ? {accountId: selectedSharedEstimatesAccountId}
        : {};

    const response = await makeRequest(
      'POST',
      '/api/v1/estimates_shared_by_me/fetch',
      requestBody,
      queryParams
    );
    const estimates = Array.isArray(response) ? response : [];

    if (estimates.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No shared estimates found</div>';
      return;
    }

    container.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>Estimate Number</th>
            <th>Name</th>
            <th>Shared With</th>
            <th>Total Cost</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${estimates
            .map(
              (estimate) => `
            <tr ondblclick="openEstimateModal('${
              estimate.sharedEstimateId || estimate.estimatesData?._id || estimate._id
            }', '${escapeHtml(
                estimate.name || estimate.estimatesData?.name || estimate.estimateName || 'Estimate'
              )}')">
              <td>${escapeHtml(
                estimate.estimateNumber || estimate.estimatesData?.estimateNumber || '-'
              )}</td>
              <td>${escapeHtml(estimate.name || estimate.estimatesData?.name || '-')}</td>
              <td>${escapeHtml(
                estimate.sharedWithAccountData?.companyName || estimate.companyName || 'Unknown'
              )}</td>
              <td>${(
                estimate.totalCostWithOtherExpenses ||
                estimate.estimatesData?.totalCostWithOtherExpenses ||
                estimate.totalCost ||
                estimate.estimatesData?.totalCost ||
                0
              ).toFixed(2)}</td>
              <td>${
                estimate.createdAt || estimate.estimatesData?.createdAt
                  ? new Date(
                      estimate.createdAt || estimate.estimatesData?.createdAt
                    ).toLocaleDateString()
                  : '-'
              }</td>
              <td>
                <div class="table-actions">
                  <button class="table-action-btn" onclick="event.stopPropagation(); openEstimateModal('${
                    estimate.sharedEstimateId || estimate.estimatesData?._id || estimate._id
                  }', '${escapeHtml(
                estimate.name || estimate.estimatesData?.name || estimate.estimateName || 'Estimate'
              )}')" title="View/Edit">
                    üëÅÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          `
            )
            .join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('Error loading shared estimates:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading shared estimates: ${error.message}</div>`;
  }
}

function searchSharedEstimates() {
  const searchVal = document.getElementById('sharedEstimatesSearch')?.value || '';
  loadSharedEstimates(searchVal || 'empty');
}

// Estimate Offers Account Filter State
let estimateOffersAccountsList = [];
let selectedEstimateOffersAccountId = 'all';

// Load accounts list for estimate offers filter
async function loadEstimateOffersAccounts() {
  try {
    const accounts = await makeRequest('GET', '/api/v1/accounts/done_estimate_share', null, null);
    estimateOffersAccountsList = Array.isArray(accounts) ? accounts : [];

    // Update dropdown options
    const filterSelect = document.getElementById('estimateOffersAccountFilter');
    if (filterSelect) {
      // Clear existing options except "All"
      filterSelect.innerHTML = '<option value="all">All Companies</option>';

      // Remove duplicates based on companyName
      const uniqueAccounts = estimateOffersAccountsList.filter(
        (account, index, self) =>
          index === self.findIndex((a) => a.companyName === account.companyName)
      );

      // Add account options
      uniqueAccounts.forEach((account) => {
        const option = document.createElement('option');
        option.value = account._id;
        option.textContent = account.companyName || '-';
        filterSelect.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Error loading estimate offers accounts:', error);
  }
}

function onEstimateOffersAccountFilterChange() {
  const filterSelect = document.getElementById('estimateOffersAccountFilter');
  if (filterSelect) {
    selectedEstimateOffersAccountId = filterSelect.value || 'all';
    searchEstimateOffers();
  }
}

// Estimates - Estimate Offers
async function loadEstimateOffers(searchVal = '') {
  const container = document.getElementById('estimateOffersTable');
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading estimate offers...</div>';

    const queryParams = {searchVal: searchVal || 'empty'};
    // Pass accountId in request body (matching production API behavior - estimates_shares/fetch expects accountId in req.body)
    const requestBody =
      selectedEstimateOffersAccountId && selectedEstimateOffersAccountId !== 'all'
        ? {accountId: selectedEstimateOffersAccountId}
        : {};

    const response = await makeRequest(
      'POST',
      '/api/v1/estimates_shares/fetch',
      requestBody,
      queryParams
    );
    const estimates = Array.isArray(response) ? response : [];

    if (estimates.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No estimate offers found</div>';
      return;
    }

    container.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>Estimate Number</th>
            <th>Name</th>
            <th>Shared By</th>
            <th>Total Cost</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${estimates
            .map(
              (estimate) => `
            <tr ondblclick="openEstimateModal('${
              estimate.sharedEstimateId || estimate.estimatesData?._id || estimate._id
            }', '${escapeHtml(
                estimate.name || estimate.estimatesData?.name || estimate.estimateName || 'Estimate'
              )}')">
              <td>${escapeHtml(
                estimate.estimateNumber || estimate.estimatesData?.estimateNumber || '-'
              )}</td>
              <td>${escapeHtml(estimate.name || estimate.estimatesData?.name || '-')}</td>
              <td>${escapeHtml(
                estimate.sharedByAccountData?.companyName ||
                  estimate.sharedByAccountName ||
                  'Unknown'
              )}</td>
              <td>${(
                estimate.totalCostWithOtherExpenses ||
                estimate.estimatesData?.totalCostWithOtherExpenses ||
                estimate.totalCost ||
                estimate.estimatesData?.totalCost ||
                0
              ).toFixed(2)}</td>
              <td>${
                estimate.createdAt || estimate.estimatesData?.createdAt
                  ? new Date(
                      estimate.createdAt || estimate.estimatesData?.createdAt
                    ).toLocaleDateString()
                  : '-'
              }</td>
              <td>
                <div class="table-actions">
                  <button class="table-action-btn" onclick="event.stopPropagation(); openEstimateModal('${
                    estimate.sharedEstimateId || estimate.estimatesData?._id || estimate._id
                  }', '${escapeHtml(
                estimate.name || estimate.estimatesData?.name || estimate.estimateName || 'Estimate'
              )}')" title="View/Edit">
                    üëÅÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          `
            )
            .join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('Error loading estimate offers:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading estimate offers: ${error.message}</div>`;
  }
}

function searchEstimateOffers() {
  const searchVal = document.getElementById('estimateOffersSearch')?.value || '';
  loadEstimateOffers(searchVal || 'empty');
}

// Section and Subsection Management
let currentSectionIdForSubsection = null;
let currentRenameId = null;
let currentRenameType = null; // 'section' or 'subsection'

// Add Section
function openAddSectionDialog() {
  const modal = document.getElementById('addSectionModal');
  const input = document.getElementById('sectionNameInput');
  if (modal && input) {
    modal.classList.remove('hidden');
    input.value = '';
    input.focus();
    document.body.style.overflow = 'hidden';
  }
}

function closeAddSectionModal() {
  const modal = document.getElementById('addSectionModal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  }
}

async function confirmAddSection() {
  const input = document.getElementById('sectionNameInput');
  if (!input || !currentEstimateId) return;

  const sectionName = input.value.trim();
  if (!sectionName) {
    showAlert('Section name is required', 'error', 'dashboardAlert');
    return;
  }

  try {
    await makeRequest('POST', '/api/v1/estimate/add_section', null, {
      estimateId: currentEstimateId,
      estimateSectionName: sectionName,
    });

    closeAddSectionModal();
    showAlert('‚úÖ Section added successfully', 'success', 'dashboardAlert');

    // Reload estimate details
    if (currentEstimateId) {
      await loadEstimateDetails(currentEstimateId);
    }
  } catch (error) {
    console.error('Error adding section:', error);
    showAlert(`‚ùå Error adding section: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// Add Subsection
function openAddSubsectionDialog(sectionId) {
  currentSectionIdForSubsection = sectionId;
  const modal = document.getElementById('addSubsectionModal');
  const input = document.getElementById('subsectionNameInput');
  if (modal && input) {
    modal.classList.remove('hidden');
    input.value = '';
    input.focus();
    document.body.style.overflow = 'hidden';
  }
}

function closeAddSubsectionModal() {
  const modal = document.getElementById('addSubsectionModal');
  if (modal) {
    modal.classList.add('hidden');
    currentSectionIdForSubsection = null;
    document.body.style.overflow = 'auto';
  }
}

async function confirmAddSubsection() {
  const input = document.getElementById('subsectionNameInput');
  if (!input || !currentSectionIdForSubsection) return;

  const subsectionName = input.value.trim();
  if (!subsectionName) {
    showAlert('Subsection name is required', 'error', 'dashboardAlert');
    return;
  }

  try {
    await makeRequest('POST', '/api/v1/estimate/add_subsection', null, {
      estimateSectionId: currentSectionIdForSubsection,
      estimateSubsectionName: subsectionName,
    });

    closeAddSubsectionModal();
    showAlert('‚úÖ Subsection added successfully', 'success', 'dashboardAlert');

    // Reload estimate details
    if (currentEstimateId) {
      await loadEstimateDetails(currentEstimateId);
    }
  } catch (error) {
    console.error('Error adding subsection:', error);
    showAlert(`‚ùå Error adding subsection: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// Rename Section/Subsection
function openRenameSectionDialog(sectionId, currentName) {
  currentRenameId = sectionId;
  currentRenameType = 'section';
  const modal = document.getElementById('renameSectionModal');
  const title = document.getElementById('renameSectionModalTitle');
  const label = document.getElementById('renameSectionModalLabel');
  const input = document.getElementById('renameSectionNameInput');
  if (modal && title && label && input) {
    title.textContent = 'Rename Section';
    label.textContent = 'Section Name';
    input.value = currentName;
    modal.classList.remove('hidden');
    input.focus();
    input.select();
    document.body.style.overflow = 'hidden';
  }
}

function openRenameSubsectionDialog(subsectionId, currentName) {
  currentRenameId = subsectionId;
  currentRenameType = 'subsection';
  const modal = document.getElementById('renameSectionModal');
  const title = document.getElementById('renameSectionModalTitle');
  const label = document.getElementById('renameSectionModalLabel');
  const input = document.getElementById('renameSectionNameInput');
  if (modal && title && label && input) {
    title.textContent = 'Rename Subsection';
    label.textContent = 'Subsection Name';
    input.value = currentName;
    modal.classList.remove('hidden');
    input.focus();
    input.select();
    document.body.style.overflow = 'hidden';
  }
}

function closeRenameSectionModal() {
  const modal = document.getElementById('renameSectionModal');
  if (modal) {
    modal.classList.add('hidden');
    currentRenameId = null;
    currentRenameType = null;
    document.body.style.overflow = 'auto';
  }
}

async function confirmRenameSection() {
  const input = document.getElementById('renameSectionNameInput');
  if (!input || !currentRenameId || !currentRenameType) return;

  const newName = input.value.trim();
  if (!newName) {
    showAlert('Name is required', 'error', 'dashboardAlert');
    return;
  }

  try {
    if (currentRenameType === 'section') {
      // estimate/rename_section uses registerHandlerSession, so path is /api/v1/estimate/rename_section
      await makeRequest('POST', '/api/v1/estimate/rename_section', null, {
        estimateSectionId: currentRenameId,
        estimateSectionNewName: newName,
      });
    } else if (currentRenameType === 'subsection') {
      // estimate/rename_subsection uses registerHandlerSession, so path is /api/v1/estimate/rename_subsection
      await makeRequest('POST', '/api/v1/estimate/rename_subsection', null, {
        estimateSubsectionId: currentRenameId,
        estimateSubsectionNewName: newName,
      });
    }

    closeRenameSectionModal();
    showAlert('‚úÖ Renamed successfully', 'success', 'dashboardAlert');

    // Reload estimate details
    if (currentEstimateId) {
      await loadEstimateDetails(currentEstimateId);
    }
  } catch (error) {
    console.error('Error renaming:', error);
    showAlert(`‚ùå Error renaming: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// Remove Section
async function removeEstimateSection(sectionId, sectionName) {
  if (
    !confirm(
      `Are you sure you want to remove the section "${sectionName}"? This will also remove all subsections and items in this section.`
    )
  ) {
    return;
  }

  try {
    await makeRequest('POST', '/api/v1/estimate/remove_section', null, {
      estimateSectionId: sectionId,
    });

    showAlert('‚úÖ Section removed successfully', 'success', 'dashboardAlert');

    // Reload estimate details
    if (currentEstimateId) {
      await loadEstimateDetails(currentEstimateId);
    }
  } catch (error) {
    console.error('Error removing section:', error);
    showAlert(`‚ùå Error removing section: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// Remove Subsection
async function removeEstimateSubsection(subsectionId, subsectionName) {
  if (
    !confirm(
      `Are you sure you want to remove the subsection "${subsectionName}"? This will also remove all items in this subsection.`
    )
  ) {
    return;
  }

  try {
    // estimate/remove_subsection uses registerHandlerSession, so path is /api/v1/estimate/remove_subsection
    await makeRequest('POST', '/api/v1/estimate/remove_subsection', null, {
      estimateSubsectionId: subsectionId,
    });

    showAlert('‚úÖ Subsection removed successfully', 'success', 'dashboardAlert');

    // Reload estimate details
    if (currentEstimateId) {
      await loadEstimateDetails(currentEstimateId);
    }
  } catch (error) {
    console.error('Error removing subsection:', error);
    showAlert(`‚ùå Error removing subsection: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// Fetch Market Prices
async function handleFetchMarketPrices() {
  if (!currentEstimateId) {
    showAlert('No estimate selected', 'error', 'dashboardAlert');
    return;
  }

  if (
    !confirm('This will update all labor and material prices to current market prices. Continue?')
  ) {
    return;
  }

  try {
    await makeRequest('POST', '/api/v1/estimate/calc_market_prices', null, {
      estimateId: currentEstimateId,
    });

    showAlert('‚úÖ Market prices fetched and updated successfully', 'success', 'dashboardAlert');

    // Reload estimate details to reflect new prices
    if (currentEstimateId) {
      await loadEstimateDetails(currentEstimateId);
    }
  } catch (error) {
    console.error('Error fetching market prices:', error);
    showAlert(`‚ùå Error fetching market prices: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
  try {
    if (e && e.key === 'Escape') {
      const addSectionModal = document.getElementById('addSectionModal');
      const addSubsectionModal = document.getElementById('addSubsectionModal');
      const renameModal = document.getElementById('renameSectionModal');
      const addLaborModal = document.getElementById('addLaborModal');
      const addLaborDetailsModal = document.getElementById('addLaborDetailsModal');

      if (
        addSectionModal &&
        addSectionModal.classList &&
        !addSectionModal.classList.contains('hidden')
      ) {
        closeAddSectionModal();
      }
      if (
        addSubsectionModal &&
        addSubsectionModal.classList &&
        !addSubsectionModal.classList.contains('hidden')
      ) {
        closeAddSubsectionModal();
      }
      if (renameModal && renameModal.classList && !renameModal.classList.contains('hidden')) {
        closeRenameSectionModal();
      }
      if (addLaborModal && addLaborModal.classList && !addLaborModal.classList.contains('hidden')) {
        closeAddLaborModal();
      }
      if (
        addLaborDetailsModal &&
        addLaborDetailsModal.classList &&
        !addLaborDetailsModal.classList.contains('hidden')
      ) {
        closeAddLaborDetailsModal();
      }
    }
  } catch (error) {
    console.error('Error in keydown handler (modal close):', error);
  }
});

// Estimate Modal Functions
async function openEstimateModal(estimateId, estimateTitle) {
  currentEstimateId = estimateId;
  currentEstimateTitle = estimateTitle;

  const modal = document.getElementById('estimateModal');
  const modalTitle = document.getElementById('estimateModalTitle');
  const modalBody = document.getElementById('estimateModalBody');

  if (modal && modalTitle && modalBody) {
    modalTitle.textContent = estimateTitle || 'Estimate';
    modal.classList.remove('hidden');
    modalBody.innerHTML = '<div class="loading">Loading estimate details...</div>';

    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';

    await loadEstimateDetails(estimateId);
  }
}

function closeEstimateModal() {
  const modal = document.getElementById('estimateModal');
  if (modal) {
    modal.classList.add('hidden');
    currentEstimateId = null;
    currentEstimateTitle = null;

    // Restore body scroll
    document.body.style.overflow = 'auto';
  }
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
  try {
    if (e && e.key === 'Escape') {
      const estimateModal = document.getElementById('estimateModal');
      const confirmModal = document.getElementById('confirmDeleteModal');
      if (estimateModal && estimateModal.classList && !estimateModal.classList.contains('hidden')) {
        closeEstimateModal();
      }
      if (confirmModal && confirmModal.classList && !confirmModal.classList.contains('hidden')) {
        closeConfirmDeleteModal();
      }
    }
  } catch (error) {
    console.error('Error in keydown handler (estimate modal close):', error);
  }
});

async function loadEstimateDetails(estimateId) {
  const modalBody = document.getElementById('estimateModalBody');
  if (!modalBody) return;

  try {
    // Fetch estimate basic info
    const estimate = await makeRequest('GET', '/api/v1/estimate/get', null, {estimateId});

    // Fetch estimate sections
    const sections = await makeRequest('GET', '/api/v1/estimate/fetch_sections', null, {
      estimateId,
    });

    let sectionsHtml = '';
    if (sections && Array.isArray(sections) && sections.length > 0) {
      const sectionPromises = sections.map(async (section) => {
        try {
          // Fetch subsections for each section
          const subsections = await makeRequest('GET', '/api/v1/estimate/fetch_subsections', null, {
            estimateSectionId: section._id,
          });

          let subsectionsHtml = '';
          if (subsections && Array.isArray(subsections) && subsections.length > 0) {
            const subsectionPromises = subsections.map(async (subsection) => {
              try {
                // Fetch labor items for each subsection
                const laborItems = await makeRequest(
                  'GET',
                  '/api/v1/estimate/fetch_labor_items',
                  null,
                  {estimateSubsectionId: subsection._id}
                );

                // Use table format for labor items instead of accordion
                // Removed old HTML generation code - now using table format
                const laborItemsTableHtml = renderLaborItemsTable(
                  laborItems,
                  subsection._id,
                  section._id
                );

                // Legacy code for reference - can be removed later
                let laborItemsHtml = '';
                if (false && laborItems && Array.isArray(laborItems) && laborItems.length > 0) {
                  // Fetch material items for each labor item separately if not in response
                  const laborItemPromises = laborItems.map(async (item) => {
                    let materialItemsHtml = '';

                    // Try to use material items from response first
                    if (
                      item.estimateMaterialItemData &&
                      Array.isArray(item.estimateMaterialItemData) &&
                      item.estimateMaterialItemData.length > 0
                    ) {
                      materialItemsHtml = item.estimateMaterialItemData
                        .map((matItem) => {
                          const materialName =
                            matItem.name ||
                            matItem.materialItemName ||
                            matItem.materialOfferItemName ||
                            matItem.estimateMaterialItemData?.[0]?.name ||
                            '-';
                          const materialPrice =
                            matItem.changableAveragePrice ||
                            matItem.averagePrice ||
                            matItem.price ||
                            0;
                          const materialQuantity = matItem.quantity || 0;
                          const materialTotal =
                            matItem.totalCost || materialPrice * materialQuantity;
                          const materialUnit =
                            matItem.measurementUnitRepresentationSymbol || matItem.unit || '';

                          return `
                          <div class="estimate-material-item" style="margin-left: 20px; padding: 8px; background: #f0f0f0; border-radius: 4px; margin-top: 5px; font-size: 13px;">
                            <div><strong>üì¶ ${escapeHtml(materialName)}</strong></div>
                            ${
                              materialQuantity
                                ? `<div>Quantity: ${materialQuantity} ${escapeHtml(
                                    materialUnit
                                  )}</div>`
                                : ''
                            }
                            ${
                              materialPrice
                                ? `<div>Unit Price: ${materialPrice.toFixed(2)}</div>`
                                : ''
                            }
                            ${materialTotal ? `<div>Total: ${materialTotal.toFixed(2)}</div>` : ''}
                          </div>
                        `;
                        })
                        .join('');
                    } else if (item._id) {
                      // If material items not in response, fetch them separately
                      try {
                        const materialItems = await makeRequest(
                          'GET',
                          '/api/v1/estimate/fetch_material_items',
                          null,
                          {estimatedLaborId: item._id}
                        );
                        if (
                          materialItems &&
                          Array.isArray(materialItems) &&
                          materialItems.length > 0
                        ) {
                          materialItemsHtml = materialItems
                            .map((matItem) => {
                              const materialName =
                                matItem.name ||
                                matItem.materialItemName ||
                                matItem.materialOfferItemName ||
                                matItem.estimateMaterialItemData?.[0]?.name ||
                                '-';
                              const materialPrice =
                                matItem.changableAveragePrice ||
                                matItem.averagePrice ||
                                matItem.price ||
                                0;
                              const materialQuantity = matItem.quantity || 0;
                              const materialTotal =
                                matItem.totalCost || materialPrice * materialQuantity;
                              const materialUnit =
                                matItem.measurementUnitRepresentationSymbol || matItem.unit || '';

                              return `
                              <div class="estimate-material-item" style="margin-left: 20px; padding: 8px; background: #f0f0f0; border-radius: 4px; margin-top: 5px; font-size: 13px;">
                                <div><strong>üì¶ ${escapeHtml(materialName)}</strong></div>
                                ${
                                  materialQuantity
                                    ? `<div>Quantity: ${materialQuantity} ${escapeHtml(
                                        materialUnit
                                      )}</div>`
                                    : ''
                                }
                                ${
                                  materialPrice
                                    ? `<div>Unit Price: ${materialPrice.toFixed(2)}</div>`
                                    : ''
                                }
                                ${
                                  materialTotal
                                    ? `<div>Total: ${materialTotal.toFixed(2)}</div>`
                                    : ''
                                }
                              </div>
                            `;
                            })
                            .join('');
                        }
                      } catch (err) {
                        console.error('Error fetching material items:', err);
                      }
                    }

                    // Labor item details
                    const laborItemName =
                      item.itemChangableName ||
                      item.itemName ||
                      item.name ||
                      item.laborItemName ||
                      item.estimateLaborItemData?.[0]?.name ||
                      '-';
                    const laborItemCode = item.itemFullCode || item.fullCode || '';
                    const laborQuantity = item.quantity || 0;
                    const laborUnitPrice =
                      item.changableAveragePrice ||
                      item.itemUnitPrice ||
                      item.unitPrice ||
                      item.presentLaborOfferAveragePrice ||
                      0;
                    const laborItemWithoutMaterial =
                      item.itemWithoutMaterial || laborQuantity * laborUnitPrice;
                    const materialTotalCost = item.materialTotalCost || 0;
                    const priceWithMaterial =
                      item.priceWithMaterial ||
                      item.totalCost ||
                      laborItemWithoutMaterial + materialTotalCost;
                    const measurementUnit =
                      item.itemMeasurementUnit || item.measurementUnitRepresentationSymbol || '';

                    return `
                      <div class="estimate-labor-item">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                          <div style="flex: 1;">
                            <div><strong>üîß ${escapeHtml(laborItemName)}</strong> ${
                      laborItemCode
                        ? `<span style="color: #666; font-size: 12px;">(${escapeHtml(
                            laborItemCode
                          )})</span>`
                        : ''
                    }</div>
                            ${
                              laborQuantity
                                ? `<div style="margin-top: 5px;">Quantity: ${laborQuantity} ${escapeHtml(
                                    measurementUnit
                                  )}</div>`
                                : ''
                            }
                            ${
                              laborUnitPrice
                                ? `<div>Unit Price: ${laborUnitPrice.toFixed(2)}</div>`
                                : ''
                            }
                            ${
                              laborItemWithoutMaterial
                                ? `<div>Labor Cost: ${laborItemWithoutMaterial.toFixed(2)}</div>`
                                : ''
                            }
                            ${
                              materialTotalCost
                                ? `<div>Material Cost: ${materialTotalCost.toFixed(2)}</div>`
                                : ''
                            }
                            ${
                              priceWithMaterial
                                ? `<div style="font-weight: 600; color: #1976d2; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;">Total (with materials): ${priceWithMaterial.toFixed(
                                    2
                                  )}</div>`
                                : ''
                            }
                          </div>
                        </div>
                        ${
                          materialItemsHtml
                            ? `<div style="margin-top: 10px;"><div style="font-weight: 600; margin-bottom: 5px;">üì¶ Materials:</div>${materialItemsHtml}</div>`
                            : ''
                        }
                      </div>
                    `;
                  });

                  const laborItemResults = await Promise.all(laborItemPromises);
                  laborItemsHtml = laborItemResults.join('');
                } else {
                  laborItemsHtml = '<div style="padding: 10px;">No labor items found</div>';
                }

                return `
                  <div class="subsection-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span>${escapeHtml(subsection.name || '-')}</span>
                      <button class="table-action-icon" onclick="openRenameSubsectionDialog('${
                        subsection._id
                      }', '${escapeHtml(subsection.name || '')}')" title="Edit">
                        ‚úèÔ∏è
                      </button>
                      <button class="table-action-icon danger" onclick="removeEstimateSubsection('${
                        subsection._id
                      }', '${escapeHtml(subsection.name || '')}')" title="Remove">
                        üóëÔ∏è
                      </button>
                    </div>
                    <span class="estimate-cost">${
                      subsection.totalCost ? subsection.totalCost.toFixed(2) : '0.00'
                    }</span>
                  </div>
                  <div style="margin-top: 12px; margin-bottom: 12px; padding-left: 12px;">
                    <button class="btn-small primary" onclick="openAddLaborDialog('${
                      subsection._id
                    }', '${section._id}', '${subsection._id}')" title="Add Labor">
                      üë∑ Add Labor
                    </button>
                  </div>
                  ${laborItemsTableHtml}
                `;
              } catch (err) {
                console.error('Error loading subsection items:', err);
                return `<div style="padding: 10px; color: red;">Error loading subsection: ${err.message}</div>`;
              }
            });

            const subsectionResults = await Promise.all(subsectionPromises);
            subsectionsHtml = subsectionResults.join('');
          }

          return `
            <div class="section-header">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span>${escapeHtml(section.name || '-')}</span>
                <button class="table-action-icon" onclick="openRenameSectionDialog('${
                  section._id
                }', '${escapeHtml(section.name || '')}')" title="Edit">
                  ‚úèÔ∏è
                </button>
                <button class="table-action-icon danger" onclick="removeEstimateSection('${
                  section._id
                }', '${escapeHtml(section.name || '')}')" title="Remove">
                  üóëÔ∏è
                </button>
              </div>
              <span class="estimate-cost">${
                section.totalCost ? section.totalCost.toFixed(2) : '0.00'
              }</span>
            </div>
            <div style="margin-top: 12px; margin-bottom: 12px; padding-left: 12px; display: flex; gap: 8px;">
              <button class="btn-small primary" onclick="openAddSubsectionDialog('${
                section._id
              }')" title="Add Subsection">
                ‚ûï Add Subsection
              </button>
              <button class="btn-small primary" onclick="openAddLaborDialog(null, '${
                section._id
              }', null)" title="Add Labor">
                üë∑ Add Labor
              </button>
            </div>
            ${subsectionsHtml || '<div style="padding: 20px;">No subsections</div>'}
          `;
        } catch (err) {
          console.error('Error loading section:', err);
          return `<div class="alert alert-error">Error loading section: ${err.message}</div>`;
        }
      });

      const sectionResults = await Promise.all(sectionPromises);
      sectionsHtml = sectionResults.join('');
    } else {
      sectionsHtml = '<div class="alert alert-info">No sections found</div>';
    }

    // Construction type options (matching production)
    const constructionTypes = [
      {id: 'currentRenovation', label: 'Current Renovation'},
      {id: 'renovation', label: 'Renovation'},
      {id: 'majorRepairs', label: 'Major repairs'},
      {id: 'reconstruction', label: 'Reconstruction'},
      {id: 'reinforcement', label: 'Reinforcement'},
      {id: 'restorationWork', label: 'Restoration Work'},
      {id: 'construction', label: 'Construction'},
    ];

    // Build modal content
    modalBody.innerHTML = `
      <!-- Estimate Info -->
      <div class="estimate-accordion">
        <div class="estimate-accordion-header" onclick="toggleEstimateAccordion(this)">
          <span>Estimate Information</span>
        </div>
        <div class="estimate-accordion-content expanded">
          <div class="estimate-info-form">
            <div class="form-field">
              <label>Name (Title)</label>
              <input 
                type="text" 
                class="editable-cell" 
                value="${escapeHtml(estimate.name || '')}" 
                data-field="name"
                onblur="updateEstimateField('name', this.value)"
                placeholder="Title"
                style="width: 100%;"
              />
            </div>
            <div class="form-field">
              <label>Estimate Number</label>
              <div class="value readonly-cell">${escapeHtml(estimate.estimateNumber || '-')}</div>
            </div>
            <div class="form-field">
              <label>Address</label>
              <input 
                type="text" 
                class="editable-cell" 
                value="${escapeHtml(estimate.address || '')}" 
                data-field="address"
                onblur="updateEstimateField('address', this.value)"
                placeholder="Address"
                style="width: 100%;"
              />
            </div>
            <div class="form-field">
              <label>Construction Type</label>
              <select 
                class="editable-cell" 
                data-field="constructionType"
                onchange="updateEstimateField('constructionType', this.value)"
                style="width: 100%;"
              >
                <option value="">Select Construction Type</option>
                ${constructionTypes
                  .map(
                    (type) => `
                  <option value="${type.id}" ${
                      estimate.constructionType === type.id ? 'selected' : ''
                    }>${escapeHtml(type.label)}</option>
                `
                  )
                  .join('')}
              </select>
            </div>
            <div class="form-field">
              <label>Building Type</label>
              <input 
                type="text" 
                class="editable-cell" 
                value="${escapeHtml(estimate.buildingType || '')}" 
                data-field="buildingType"
                onblur="updateEstimateField('buildingType', this.value)"
                placeholder="Type of building"
                style="width: 100%;"
              />
            </div>
            <div class="form-field">
              <label>Construction Surface</label>
              <input 
                type="text" 
                class="editable-cell" 
                value="${escapeHtml(estimate.constructionSurface || '')}" 
                data-field="constructionSurface"
                onblur="updateEstimateField('constructionSurface', this.value)"
                placeholder="Construction surface"
                style="width: 100%;"
              />
            </div>
            <div class="form-field">
              <label>Total Cost</label>
              <div class="value readonly-cell">${
                estimate.totalCostWithOtherExpenses || estimate.totalCost
                  ? (estimate.totalCostWithOtherExpenses || estimate.totalCost).toFixed(2)
                  : '0.00'
              }</div>
            </div>
            <div class="form-field">
              <label>Created At</label>
              <div class="value readonly-cell">${
                estimate.createdAt ? new Date(estimate.createdAt).toLocaleDateString() : '-'
              }</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estimate Sections -->
      <div style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #ddd;">
          <h3 style="margin: 0;">Estimate Sections</h3>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-primary" onclick="handleFetchMarketPrices()" title="Fetch Market Prices">
              üìä Market Prices
            </button>
            <button class="btn btn-primary" onclick="openAddSectionDialog()" title="Add Section">
              ‚ûï Add Section
            </button>
          </div>
        </div>
        ${sectionsHtml}
      </div>

      <!-- Other Expenses -->
      ${
        estimate.otherExpenses &&
        Array.isArray(estimate.otherExpenses) &&
        estimate.otherExpenses.length > 0
          ? `
        <div class="estimate-accordion">
          <div class="estimate-accordion-header" onclick="toggleEstimateAccordion(this)">
            <span>Other Expenses</span>
          </div>
          <div class="estimate-accordion-content">
            <div class="estimate-info-form">
              ${estimate.otherExpenses
                .map((expense, index) => {
                  const expenseKey = Object.keys(expense)[0];
                  const expenseValue = expense[expenseKey];

                  // Skip typeOfCost with value 0
                  if (expenseKey === 'typeOfCost' && expenseValue === 0) {
                    return '';
                  }

                  let expenseName = expenseKey;
                  // Try to map expense keys to readable names
                  const expenseNames = {
                    overhead: 'Overhead',
                    profit: 'Profit',
                    transport: 'Transport',
                    installation: 'Installation',
                    typeOfCost: 'Type of Cost',
                  };
                  expenseName = expenseNames[expenseKey] || expenseKey;

                  const percentageCalc =
                    expenseValue && estimate.totalCost
                      ? ((expenseValue * estimate.totalCost) / 100).toFixed(2)
                      : '0.00';

                  return `
                  <div class="form-field">
                    <label>${escapeHtml(expenseName)}</label>
                    <div class="value">
                      ${expenseValue ? `${expenseValue}% (${percentageCalc})` : '0%'}
                    </div>
                  </div>
                `;
                })
                .filter((html) => html)
                .join('')}
            </div>
          </div>
        </div>
      `
          : ''
      }
    `;
  } catch (error) {
    console.error('Error loading estimate details:', error);
    modalBody.innerHTML = `<div class="alert alert-error">Error loading estimate details: ${error.message}</div>`;
  }
}

function toggleEstimateAccordion(header) {
  event.stopPropagation();
  const content = header.nextElementSibling;
  if (!content) return;

  const isExpanded = content.classList.contains('expanded');

  if (isExpanded) {
    content.classList.remove('expanded');
    content.style.display = 'none';
  } else {
    content.classList.add('expanded');
    content.style.display = 'block';
  }
}

function printEstimate() {
  if (!currentEstimateId) {
    showAlert('No estimate selected', 'error', 'dashboardAlert');
    return;
  }
  const printUrl = `${getBackendUrl()}/api/v1/estimate/generate_html?estimateId=${currentEstimateId}`;
  window.open(printUrl, '_blank');
}

function confirmDeleteEstimateDialog(estimateId) {
  deleteEstimateId = estimateId;
  const modal = document.getElementById('confirmDeleteModal');
  if (modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
}

function closeConfirmDeleteModal() {
  deleteEstimateId = null;
  const modal = document.getElementById('confirmDeleteModal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  }
}

async function confirmDeleteEstimate() {
  if (!deleteEstimateId) return;

  try {
    // Delete endpoint expects estimateId as query parameter (requireQueryParam checks both query and body)
    await makeRequest('POST', '/api/v1/estimate/delete', null, {
      estimateId: deleteEstimateId,
    });
    closeConfirmDeleteModal();
    loadEstimates(); // Reload estimates list
    showAlert('‚úÖ Estimate deleted successfully', 'success', 'dashboardAlert');
  } catch (error) {
    console.error('Error deleting estimate:', error);
    showAlert(`‚ùå Error deleting estimate: ${error.message}`, 'error', 'dashboardAlert');
  }
}

function openCreateEstimateDialog() {
  showAlert('Create Estimate functionality coming soon', 'info');
}

// Helper function to render labor items table
function renderLaborItemsTable(laborItems, subsectionId, sectionId) {
  if (!laborItems || !Array.isArray(laborItems) || laborItems.length === 0) {
    return '<div style="padding: 20px; text-align: center; color: #999;">No labor items found</div>';
  }

  const tableRows = laborItems
    .map((item, index) => {
      const laborItemId = item._id;
      const laborItemName =
        item.itemChangableName ||
        item.laborOfferItemName ||
        item.itemName ||
        item.name ||
        item.laborItemName ||
        item.estimateLaborItemData?.[0]?.name ||
        '-';
      // Use fullCode from estimateLaborItemData lookup (like production - EstimateLaborItemDisplayData)
      const laborItemCode =
        item.estimateLaborItemData?.[0]?.fullCode || item.itemFullCode || item.fullCode || '-';
      const laborHours = item.itemLaborHours || item.laborHours || 0;
      const measurementUnit =
        item.itemMeasurementUnit ||
        item.estimateMeasurementUnitData?.[0]?.representationSymbol ||
        item.measurementUnitRepresentationSymbol ||
        '';
      const quantity = item.quantity || 0;
      const price =
        item.changableAveragePrice ||
        item.itemChangableAveragePrice ||
        item.itemUnitPrice ||
        item.unitPrice ||
        item.presentLaborOfferAveragePrice ||
        item.presentItemOfferAveragePrice ||
        0;
      const itemWithoutMaterial = item.itemWithoutMaterial || quantity * price;
      const materialTotalCost = item.materialTotalCost || 0;
      const priceWithMaterial =
        item.priceWithMaterial || item.totalCost || itemWithoutMaterial + materialTotalCost;
      const unitPrice =
        item.itemUnitPrice ||
        item.estimateLaborOffersData?.[0]?.price ||
        item.laborOfferData?.[0]?.price ||
        price;

      return `
        <tr data-labor-item-id="${laborItemId}" data-index="${index}">
          <td>
            <button class="table-action-btn" onclick="openLaborItemView('${laborItemId}', '${escapeHtml(
        laborItemName
      )}')" title="View Details">
              ${escapeHtml(laborItemCode || '-')}
            </button>
          </td>
          <td>
            <input 
              type="text" 
              class="editable-cell" 
              value="${escapeHtml(laborItemName)}" 
              data-field="itemChangableName"
              data-labor-item-id="${laborItemId}"
              onblur="updateLaborItemField('${laborItemId}', 'itemChangableName', this.value)"
              style="width: 100%;"
            />
          </td>
          <td>
            <input 
              type="number" 
              step="0.01"
              class="editable-cell" 
              value="${laborHours}" 
              data-field="itemLaborHours"
              data-labor-item-id="${laborItemId}"
              onblur="updateLaborItemField('${laborItemId}', 'itemLaborHours', this.value)"
              style="width: 80px;"
            />
          </td>
          <td class="readonly-cell">${escapeHtml(measurementUnit)}</td>
          <td>
            <input 
              type="number" 
              step="0.01"
              class="editable-cell" 
              value="${quantity}" 
              data-field="quantity"
              data-labor-item-id="${laborItemId}"
              onblur="updateLaborItemField('${laborItemId}', 'quantity', this.value)"
              style="width: 100px;"
            />
          </td>
          <td>
            <input 
              type="number" 
              step="0.01"
              class="editable-cell" 
              value="${price}" 
              data-field="itemChangableAveragePrice"
              data-labor-item-id="${laborItemId}"
              onblur="updateLaborItemField('${laborItemId}', 'itemChangableAveragePrice', this.value)"
              style="width: 100px;"
            />
          </td>
          <td class="readonly-cell">${itemWithoutMaterial.toFixed(2)}</td>
          <td class="readonly-cell">${materialTotalCost.toFixed(2)}</td>
          <td class="readonly-cell">${priceWithMaterial.toFixed(2)}</td>
          <td class="readonly-cell">${unitPrice.toFixed(2)}</td>
          <td>
            <button class="table-action-icon" onclick="openMaterialsDialog('${laborItemId}', '${escapeHtml(
        laborItemName
      )}')" title="View Materials">
              üì¶
            </button>
          </td>
          <td>
            <div class="table-row-actions">
              <button class="table-action-icon" onclick="editLaborItem('${laborItemId}', '${escapeHtml(
        laborItemName
      )}')" title="Edit">
                ‚úèÔ∏è
              </button>
              <button class="table-action-icon danger" onclick="removeLaborItem('${laborItemId}', '${escapeHtml(
        laborItemName
      )}')" title="Remove">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      `;
    })
    .join('');

  return `
    <div class="table-wrapper">
      <div class="filter-bar">
        <input 
          type="text" 
          class="filter-input" 
          placeholder="Filter labor items..." 
          onkeyup="filterLaborItems(this.value, '${subsectionId}')"
        />
      </div>
      <table class="estimate-table" id="labor-items-table-${subsectionId}">
        <thead>
          <tr>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 0)">ID <span class="sort-indicator">‚Üï</span></th>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 1)">Labor <span class="sort-indicator">‚Üï</span></th>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 2)">Work per hour <span class="sort-indicator">‚Üï</span></th>
            <th>Unit</th>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 4)">Quantity <span class="sort-indicator">‚Üï</span></th>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 5)">Price <span class="sort-indicator">‚Üï</span></th>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 6)">Without material <span class="sort-indicator">‚Üï</span></th>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 7)">Material Cost <span class="sort-indicator">‚Üï</span></th>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 8)">Price with material <span class="sort-indicator">‚Üï</span></th>
            <th class="sortable-header" onclick="sortTable('labor-items-table-${subsectionId}', 9)">Unit Price <span class="sort-indicator">‚Üï</span></th>
            <th>Materials</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
    </div>
  `;
}

// Update estimate field
let updateEstimateTimeout = null;
let lastEstimateFieldUpdate = {};
async function updateEstimateField(fieldKey, fieldValue) {
  if (updateEstimateTimeout) {
    clearTimeout(updateEstimateTimeout);
  }

  // Check if value actually changed
  if (lastEstimateFieldUpdate[fieldKey] === fieldValue) {
    return;
  }
  lastEstimateFieldUpdate[fieldKey] = fieldValue;

  updateEstimateTimeout = setTimeout(async () => {
    if (!currentEstimateId || !fieldKey || fieldValue === undefined) {
      return;
    }

    try {
      await makeRequest('POST', '/api/v1/estimate/rename', null, {
        estimateId: currentEstimateId,
        fieldKey: fieldKey,
        fieldValue: fieldValue || '',
      });

      // Reload estimate details to reflect changes
      if (currentEstimateId) {
        await loadEstimateDetails(currentEstimateId);
      }
    } catch (error) {
      console.error('Error updating estimate field:', error);
      showAlert(`Error updating field: ${error.message}`, 'error', 'dashboardAlert');
      // Reload to revert changes
      if (currentEstimateId) {
        await loadEstimateDetails(currentEstimateId);
      }
    }
  }, 500); // Debounce 500ms
}

// Update labor item field
let updateLaborItemTimeout = null;
async function updateLaborItemField(laborItemId, field, value) {
  if (updateLaborItemTimeout) {
    clearTimeout(updateLaborItemTimeout);
  }

  updateLaborItemTimeout = setTimeout(async () => {
    try {
      const updateData = {};
      updateData[field] = value;

      await makeRequest('POST', '/api/v1/estimate/update_labor_item', updateData, {
        estimatedLaborId: laborItemId,
      });

      // Reload the estimate details to reflect changes
      if (currentEstimateId) {
        await loadEstimateDetails(currentEstimateId);
      }
    } catch (error) {
      console.error('Error updating labor item:', error);
      showAlert(`Error updating field: ${error.message}`, 'error', 'dashboardAlert');
      // Reload to revert changes
      if (currentEstimateId) {
        await loadEstimateDetails(currentEstimateId);
      }
    }
  }, 500); // Debounce 500ms
}

// Filter labor items
function filterLaborItems(searchValue, subsectionId) {
  const table = document.getElementById(`labor-items-table-${subsectionId}`);
  if (!table) return;

  const rows = table.querySelectorAll('tbody tr');
  const searchLower = searchValue.toLowerCase();

  rows.forEach((row) => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchLower) ? '' : 'none';
  });
}

// Sort table
let sortDirections = {};
function sortTable(tableId, columnIndex) {
  const table = document.getElementById(tableId);
  if (!table) return;

  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));

  const direction = sortDirections[`${tableId}-${columnIndex}`] || 'asc';
  sortDirections[`${tableId}-${columnIndex}`] = direction === 'asc' ? 'desc' : 'asc';

  rows.sort((a, b) => {
    const aCell = a.cells[columnIndex];
    const bCell = b.cells[columnIndex];

    if (!aCell || !bCell) return 0;

    const aText = aCell.textContent.trim();
    const bText = bCell.textContent.trim();

    // Try to parse as number
    const aNum = parseFloat(aText);
    const bNum = parseFloat(bText);

    if (!isNaN(aNum) && !isNaN(bNum)) {
      return direction === 'asc' ? aNum - bNum : bNum - aNum;
    }

    // String comparison
    if (direction === 'asc') {
      return aText.localeCompare(bText);
    } else {
      return bText.localeCompare(aText);
    }
  });

  rows.forEach((row) => tbody.appendChild(row));
}

// Open materials dialog
let currentMaterialsLaborId = null;
let currentMaterialsLaborName = null;

async function openMaterialsDialog(laborId, laborName) {
  currentMaterialsLaborId = laborId;
  currentMaterialsLaborName = laborName;

  const modal = document.getElementById('materialsModal');
  const modalTitle = document.getElementById('materialsModalTitle');
  const modalBody = document.getElementById('materialsModalBody');

  if (modal && modalTitle && modalBody) {
    modalTitle.textContent = `Materials: ${laborName}`;
    modal.classList.remove('hidden');
    modalBody.innerHTML = '<div class="loading">Loading materials...</div>';

    document.body.style.overflow = 'hidden';

    await loadMaterials(laborId);
  }
}

function closeMaterialsModal() {
  const modal = document.getElementById('materialsModal');
  if (modal) {
    modal.classList.add('hidden');
    currentMaterialsLaborId = null;
    currentMaterialsLaborName = null;
    document.body.style.overflow = 'auto';
  }
}

// Store if materials modal was open (to reopen after adding)
let wasMaterialsModalOpen = false;
let savedMaterialsLaborId = null;
let savedMaterialsLaborName = null;

// Open add material dialog from materials modal (uses current labor ID)
// Don't close materials modal - just open add material dialog on top (like production)
function openAddMaterialDialogFromMaterialsModal() {
  if (!currentMaterialsLaborId || !currentMaterialsLaborName) {
    showAlert('No labor item selected', 'error', 'dashboardAlert');
    return;
  }
  // Remember that materials modal was open (but keep it open, just open add dialog on top)
  wasMaterialsModalOpen = true;
  savedMaterialsLaborId = currentMaterialsLaborId;
  savedMaterialsLaborName = currentMaterialsLaborName;
  console.log('Opening add material dialog while materials modal is open:', {
    wasMaterialsModalOpen,
    savedMaterialsLaborId,
    savedMaterialsLaborName,
  });
  // Open add material dialog without closing materials modal (like production)
  openAddMaterialDialogForLabor(currentMaterialsLaborId, currentMaterialsLaborName);
}

async function loadMaterials(laborId) {
  const modalBody = document.getElementById('materialsModalBody');
  if (!modalBody) return;

  try {
    const materialItems = await makeRequest('GET', '/api/v1/estimate/fetch_material_items', null, {
      estimatedLaborId: laborId,
    });

    if (!materialItems || !Array.isArray(materialItems) || materialItems.length === 0) {
      modalBody.innerHTML = '<div class="alert alert-info">No materials found</div>';
      return;
    }

    const tableRows = materialItems
      .map((item) => {
        const materialId = item._id;
        const materialName =
          item.materialOfferItemName ||
          item.name ||
          item.materialItemName ||
          item.estimateMaterialItemData?.[0]?.name ||
          '-';
        // Use fullCode from estimateMaterialItemData lookup (like production - EstimateMaterialItemDisplayData)
        const materialCode =
          item.estimateMaterialItemData?.[0]?.fullCode ||
          item.estimatedMaterialFullCode ||
          item.fullCode ||
          '-';
        const materialUnit =
          item.estimateMeasurementUnitData?.[0]?.representationSymbol ||
          item.measurementUnitRepresentationSymbol ||
          item.unit ||
          '';
        const consumptionNorm = item.materialConsumptionNorm || 0;
        const quantity = item.quantity || 0;
        const price = item.changableAveragePrice || item.averagePrice || item.price || 0;
        const total = item.totalCost || price * quantity;

        return `
          <tr data-material-item-id="${materialId}">
          <td>
            <button class="table-action-btn" onclick="openMaterialItemView('${materialId}')" title="View Details">
              ${escapeHtml(materialCode || '-')}
            </button>
          </td>
            <td>
              <input 
                type="text" 
                class="editable-cell" 
                value="${escapeHtml(materialName)}" 
                data-field="materialOfferItemName"
                data-material-item-id="${materialId}"
                onblur="updateMaterialItemField('${materialId}', 'materialOfferItemName', this.value)"
                style="width: 100%;"
              />
            </td>
            <td class="readonly-cell">${escapeHtml(materialUnit)}</td>
            <td>
              <input 
                type="number" 
                step="0.01"
                class="editable-cell" 
                value="${consumptionNorm}" 
                data-field="materialConsumptionNorm"
                data-material-item-id="${materialId}"
                onblur="updateMaterialItemField('${materialId}', 'materialConsumptionNorm', this.value)"
                style="width: 100px;"
              />
            </td>
            <td class="readonly-cell">${quantity.toFixed(2)}</td>
            <td>
              <input 
                type="number" 
                step="0.01"
                class="editable-cell" 
                value="${price}" 
                data-field="changableAveragePrice"
                data-material-item-id="${materialId}"
                onblur="updateMaterialItemField('${materialId}', 'changableAveragePrice', this.value)"
                style="width: 100px;"
              />
            </td>
            <td class="readonly-cell">${total.toFixed(2)}</td>
            <td>
              <div class="table-row-actions">
                <button class="table-action-icon danger" onclick="removeMaterialItem('${materialId}')" title="Remove">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        `;
      })
      .join('');

    modalBody.innerHTML = `
      <div class="filter-bar">
        <input 
          type="text" 
          class="filter-input" 
          placeholder="Filter materials..." 
          onkeyup="filterMaterials(this.value)"
        />
      </div>
      <div class="table-wrapper">
        <table class="estimate-table" id="materials-table">
          <thead>
            <tr>
              <th class="sortable-header" onclick="sortTable('materials-table', 0)">ID <span class="sort-indicator">‚Üï</span></th>
              <th class="sortable-header" onclick="sortTable('materials-table', 1)">Material <span class="sort-indicator">‚Üï</span></th>
              <th>Unit</th>
              <th class="sortable-header" onclick="sortTable('materials-table', 3)">Material consumption norm <span class="sort-indicator">‚Üï</span></th>
              <th class="sortable-header" onclick="sortTable('materials-table', 4)">Quantity <span class="sort-indicator">‚Üï</span></th>
              <th class="sortable-header" onclick="sortTable('materials-table', 5)">Price <span class="sort-indicator">‚Üï</span></th>
              <th class="sortable-header" onclick="sortTable('materials-table', 6)">Total <span class="sort-indicator">‚Üï</span></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      </div>
    `;
  } catch (error) {
    console.error('Error loading materials:', error);
    modalBody.innerHTML = `<div class="alert alert-error">Error loading materials: ${error.message}</div>`;
  }
}

// Update material item field
let updateMaterialItemTimeout = null;
async function updateMaterialItemField(materialId, field, value) {
  if (updateMaterialItemTimeout) {
    clearTimeout(updateMaterialItemTimeout);
  }

  updateMaterialItemTimeout = setTimeout(async () => {
    try {
      const updateData = {};
      updateData[field] = value;

      await makeRequest('POST', '/api/v1/estimate/update_material_item', updateData, {
        estimatedMaterialId: materialId,
        estimatedLaborId: currentMaterialsLaborId || '',
      });

      // Reload materials
      if (currentMaterialsLaborId) {
        await loadMaterials(currentMaterialsLaborId);
      }

      // Reload estimate details to reflect cost changes
      if (currentEstimateId) {
        await loadEstimateDetails(currentEstimateId);
      }
    } catch (error) {
      console.error('Error updating material item:', error);
      showAlert(`Error updating field: ${error.message}`, 'error', 'dashboardAlert');
      // Reload to revert changes
      if (currentMaterialsLaborId) {
        await loadMaterials(currentMaterialsLaborId);
      }
    }
  }, 500);
}

// Filter materials
function filterMaterials(searchValue) {
  const table = document.getElementById('materials-table');
  if (!table) return;

  const rows = table.querySelectorAll('tbody tr');
  const searchLower = searchValue.toLowerCase();

  rows.forEach((row) => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchLower) ? '' : 'none';
  });
}

// Placeholder functions for actions
function openLaborItemView(laborId, laborName) {
  showAlert(`View labor item: ${laborName}`, 'info', 'dashboardAlert');
}

function editLaborItem(laborId, laborName) {
  showAlert(`Edit labor item: ${laborName}`, 'info', 'dashboardAlert');
}

async function removeLaborItem(laborId, laborName) {
  if (!confirm(`Are you sure you want to remove "${laborName}"?`)) {
    return;
  }

  try {
    await makeRequest('POST', '/api/v1/estimate/remove_labor_item', null, {
      estimateLaborItemId: laborId,
    });

    showAlert('Labor item removed successfully', 'success', 'dashboardAlert');

    // Reload estimate details
    if (currentEstimateId) {
      await loadEstimateDetails(currentEstimateId);
    }
  } catch (error) {
    console.error('Error removing labor item:', error);
    showAlert(`Error removing labor item: ${error.message}`, 'error', 'dashboardAlert');
  }
}

function openMaterialItemView(materialId) {
  showAlert(`View material item: ${materialId}`, 'info', 'dashboardAlert');
}

async function removeMaterialItem(materialId) {
  if (!confirm('Are you sure you want to remove this material item?')) {
    return;
  }

  try {
    await makeRequest('POST', '/api/v1/estimate/remove_material_item', null, {
      estimateMaterialItemId: materialId,
    });

    showAlert('Material item removed successfully', 'success', 'dashboardAlert');

    // Reload materials
    if (currentMaterialsLaborId) {
      await loadMaterials(currentMaterialsLaborId);
    }

    // Reload estimate details to reflect cost changes
    if (currentEstimateId) {
      await loadEstimateDetails(currentEstimateId);
    }
  } catch (error) {
    console.error('Error removing material item:', error);
    showAlert(`Error removing material item: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// Users
async function loadUsers(searchVal = '') {
  const container = document.getElementById('usersTable');
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading users...</div>';

    const queryParams = {};
    if (searchVal) queryParams.search = searchVal;

    const response = await makeRequest('GET', '/api/v1/users/fetch', null, queryParams);
    const users = Array.isArray(response) ? response : [];

    if (users.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No users found</div>';
      return;
    }

    container.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>Account</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${users
            .map(
              (user) => `
            <tr>
              <td>${escapeHtml(user.companyName || '-')}</td>
              <td>${escapeHtml(user.firstName || '-')}</td>
              <td>${escapeHtml(user.lastName || '-')}</td>
              <td>${escapeHtml(user.email || '-')}</td>
              <td>${escapeHtml(user.phoneNumber || '-')}</td>
              <td>${user.isActive !== false ? 'Active' : 'Inactive'}</td>
            </tr>
          `
            )
            .join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('Error loading users:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading users: ${error.message}</div>`;
  }
}

function searchUsers() {
  const searchVal = document.getElementById('usersSearch')?.value || '';
  loadUsers(searchVal || null);
}

// Add Labor Item Management
let currentAddLaborSubsectionId = null;
let currentAddLaborSectionId = null;
let selectedLaborItemData = null;

// Material selection state
let selectedMaterialItemData = null;
let currentAddMaterialLaborId = null;
let expandedMaterialAccordions = new Set();
let materialCategoriesData = [];
let laborCategoriesData = [];
let expandedLaborAccordions = new Set();

// Open Add Labor Dialog
// If subsectionId is null, it means adding to section level (will create empty subsection)
async function openAddLaborDialog(subsectionId, sectionId, subsectionIdParam) {
  console.log('openAddLaborDialog called with:', {
    subsectionId,
    sectionId,
    subsectionIdParam,
    types: {
      subsectionId: typeof subsectionId,
      sectionId: typeof sectionId,
      subsectionIdParam: typeof subsectionIdParam,
    },
  });

  // Handle section-level addition (subsectionId is null)
  if (subsectionId === null || subsectionId === 'null' || subsectionId === '') {
    currentAddLaborSubsectionId = null;
    currentAddLaborSectionId = sectionId || subsectionIdParam;
    console.log('Section-level addition. Section ID:', currentAddLaborSectionId);
  } else {
    // Subsection-level addition
    currentAddLaborSubsectionId = subsectionIdParam || subsectionId;
    currentAddLaborSectionId = sectionId;
    console.log(
      'Subsection-level addition. Subsection ID:',
      currentAddLaborSubsectionId,
      'Section ID:',
      currentAddLaborSectionId
    );
  }

  // Ensure IDs are strings
  if (currentAddLaborSectionId) {
    currentAddLaborSectionId = String(currentAddLaborSectionId);
  }
  if (currentAddLaborSubsectionId) {
    currentAddLaborSubsectionId = String(currentAddLaborSubsectionId);
  }

  console.log('Final IDs set:', {
    subsectionId: currentAddLaborSubsectionId,
    sectionId: currentAddLaborSectionId,
  });

  selectedLaborItemData = null;
  expandedLaborAccordions.clear();

  const modal = document.getElementById('addLaborModal');
  if (modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Load labor categories
    await loadLaborCategoriesForDialog('');
  } else {
    console.error('Add labor modal not found!');
  }
}

function closeAddLaborModal() {
  const modal = document.getElementById('addLaborModal');
  if (modal) {
    modal.classList.add('hidden');
    // DON'T clear section/subsection IDs here - we need them for confirmAddLaborItem!
    // Only clear selectedLaborItemData if we're actually canceling (not opening details modal)
    // The IDs will be cleared when the details modal is closed
    expandedLaborAccordions.clear();
    // Don't restore body overflow here - details modal will handle it
  }
}

// Load labor categories (Level 1)
async function loadLaborCategoriesForDialog(searchVal = '') {
  const container = document.getElementById('addLaborCategoriesAccordion');
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading labor categories...</div>';

    const queryParams = {};
    if (searchVal) {
      queryParams.searchVal = searchVal;
    }

    const response = await makeRequest('GET', '/api/v1/labor/fetch_categories', null, queryParams);
    laborCategoriesData = Array.isArray(response) ? response : [];

    console.log('Categories loaded:', laborCategoriesData.length, 'categories');
    if (laborCategoriesData.length > 0) {
      console.log('First category sample:', {
        _id: laborCategoriesData[0]._id,
        _idType: typeof laborCategoriesData[0]._id,
        code: laborCategoriesData[0].code,
        name: laborCategoriesData[0].name,
      });
    }

    if (laborCategoriesData.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No labor categories found</div>';
      return;
    }

    // Render categories accordion
    container.innerHTML = laborCategoriesData
      .map(
        (category) => `
      <div class="estimate-accordion" style="margin-bottom: 8px;">
        <div 
          class="estimate-accordion-header" 
          onclick="toggleLaborCategory('${category._id}')"
          style="cursor: pointer; padding: 12px 16px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;"
        >
          <span><strong>${escapeHtml(category.code || '')}</strong> ${escapeHtml(
          category.name || '-'
        )} ${category.childrenQuantity ? `(${category.childrenQuantity})` : '(0)'}</span>
          <span style="font-size: 18px;">${
            expandedLaborAccordions.has(`cat-${category._id}`) ? '‚ñº' : '‚ñ∂'
          }</span>
        </div>
        <div 
          id="cat-${category._id}-content" 
          class="estimate-accordion-content" 
          style="display: ${
            expandedLaborAccordions.has(`cat-${category._id}`) ? 'block' : 'none'
          }; padding: 12px 16px; border-left: 2px solid #ddd; margin-left: 12px; margin-top: 8px;"
        >
          <div id="cat-${category._id}-subcategories" class="loading">Loading subcategories...</div>
        </div>
      </div>
    `
      )
      .join('');
  } catch (error) {
    console.error('Error loading labor categories:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading labor categories: ${error.message}</div>`;
  }
}

// Toggle labor category (expand/collapse to load subcategories)
async function toggleLaborCategory(categoryId) {
  console.log('toggleLaborCategory called with:', categoryId, 'type:', typeof categoryId);
  const accordionId = `cat-${categoryId}`;
  const isExpanded = expandedLaborAccordions.has(accordionId);

  // Update expanded state first
  if (isExpanded) {
    expandedLaborAccordions.delete(accordionId);
  } else {
    expandedLaborAccordions.add(accordionId);
  }

  // Update UI visibility BEFORE loading subcategories
  const content = document.getElementById(`${accordionId}-content`);
  if (content) {
    content.style.display = expandedLaborAccordions.has(accordionId) ? 'block' : 'none';
  }

  // Update icon
  const header = document.querySelector(`[onclick="toggleLaborCategory('${categoryId}')"]`);
  if (header) {
    const icon = header.querySelector('span:last-child');
    if (icon) {
      icon.textContent = expandedLaborAccordions.has(accordionId) ? '‚ñº' : '‚ñ∂';
    }
  }

  // Load subcategories only if expanding
  if (expandedLaborAccordions.has(accordionId)) {
    // Ensure categoryId is a string
    const categoryIdStr = String(categoryId);
    console.log('Loading subcategories for category:', categoryIdStr);
    await loadLaborSubcategories(categoryIdStr);
  }
}

// Load labor subcategories (Level 2)
async function loadLaborSubcategories(categoryId) {
  const container = document.getElementById(`cat-${categoryId}-subcategories`);
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading subcategories...</div>';

    // API expects categoryMongoId and searchVal as query params, and optional filters in body
    // Production uses: args: { categoryMongoId, searchVal }, json: selectedFiltersData
    // The API uses requireQueryParam for categoryMongoId, so it must be in query string
    // Production API call: searchVal='' (empty string) and body: {"categoryId":null,"subcategoryId":null}
    const queryParams = {
      categoryMongoId: String(categoryId), // Ensure it's a string
      searchVal: '', // Empty string, not 'empty' - matching production exactly
    };

    // Pass body with categoryId and subcategoryId as null (matching production exactly)
    const requestBody = {
      categoryId: null,
      subcategoryId: null,
    };

    const response = await makeRequest(
      'POST',
      '/api/v1/labor/fetch_subcategories',
      requestBody,
      queryParams
    );

    console.log('Subcategories API call:', {
      categoryId,
      queryParams,
      responseType: typeof response,
      isArray: Array.isArray(response),
      responseLength: Array.isArray(response) ? response.length : 'N/A',
    });

    if (!response) {
      console.error('Empty response from subcategories API');
      container.innerHTML =
        '<div style="padding: 8px; color: #d32f2f;">Error: Empty response from server</div>';
      return;
    }

    const subcategories = Array.isArray(response) ? response : [];

    console.log('Parsed subcategories:', subcategories.length, 'items');

    if (subcategories.length === 0) {
      container.innerHTML = '<div style="padding: 8px; color: #666;">No subcategories found</div>';
      return;
    }

    // Render subcategories accordion
    container.innerHTML = subcategories
      .map(
        (subcat) => `
      <div class="estimate-accordion" style="margin-bottom: 8px;">
        <div 
          class="estimate-accordion-header" 
          onclick="toggleLaborSubcategory('${categoryId}', '${subcat._id}')"
          style="cursor: pointer; padding: 10px 14px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;"
        >
          <span><strong>${escapeHtml(subcat.code || '')}</strong> ${escapeHtml(
          subcat.name || '-'
        )} ${subcat.childrenQuantity ? `(${subcat.childrenQuantity})` : '(0)'}</span>
          <span style="font-size: 16px;">${
            expandedLaborAccordions.has(`subcat-${subcat._id}`) ? '‚ñº' : '‚ñ∂'
          }</span>
        </div>
        <div 
          id="subcat-${subcat._id}-content" 
          class="estimate-accordion-content" 
          style="display: ${
            expandedLaborAccordions.has(`subcat-${subcat._id}`) ? 'block' : 'none'
          }; padding: 12px 16px; border-left: 2px solid #ddd; margin-left: 12px; margin-top: 8px;"
        >
          <div id="subcat-${subcat._id}-items" class="loading">Loading items...</div>
        </div>
      </div>
    `
      )
      .join('');
  } catch (error) {
    console.error('Error loading labor subcategories:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading subcategories: ${error.message}</div>`;
  }
}

// Toggle labor subcategory (expand/collapse to load items)
async function toggleLaborSubcategory(categoryId, subcategoryId) {
  const accordionId = `subcat-${subcategoryId}`;
  const isExpanded = expandedLaborAccordions.has(accordionId);

  // Update expanded state first
  if (isExpanded) {
    expandedLaborAccordions.delete(accordionId);
  } else {
    expandedLaborAccordions.add(accordionId);
  }

  // Update UI visibility BEFORE loading items
  const content = document.getElementById(`${accordionId}-content`);
  if (content) {
    content.style.display = expandedLaborAccordions.has(accordionId) ? 'block' : 'none';
  }

  // Update icon
  const header = document.querySelector(
    `[onclick*="toggleLaborSubcategory('${categoryId}', '${subcategoryId}')"]`
  );
  if (header) {
    const icon = header.querySelector('span:last-child');
    if (icon) {
      icon.textContent = expandedLaborAccordions.has(accordionId) ? '‚ñº' : '‚ñ∂';
    }
  }

  // Load items only if expanding
  if (expandedLaborAccordions.has(accordionId)) {
    await loadLaborItems(subcategoryId);
  }
}

// Load labor items (Level 3) - show as table
async function loadLaborItems(subcategoryId) {
  const container = document.getElementById(`subcat-${subcategoryId}-items`);
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading items...</div>';

    // Production uses GET request with query params: subcategoryMongoId, searchVal (empty), isSorting, calledFromPage
    const queryParams = {
      subcategoryMongoId: String(subcategoryId),
      searchVal: '', // Empty string - matching production exactly
      isSorting: 'true',
      calledFromPage: 'estCatAccordion',
    };

    // Production uses GET request (no body)
    const response = await makeRequest(
      'GET',
      '/api/v1/labor/fetch_items_with_average_price',
      null,
      queryParams
    );

    console.log('Labor items response for subcategory', subcategoryId, ':', response);

    const items = Array.isArray(response) ? response : [];

    if (items.length === 0) {
      container.innerHTML = '<div style="padding: 8px; color: #666;">No items found</div>';
      return;
    }

    // Render items table
    // API returns measurementUnitData as an array from lookup, need to extract first element
    container.innerHTML = `
      <table class="table" style="width: 100%;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Work per hour</th>
            <th>Unit</th>
            <th>Average Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${items
            .map((item) => {
              // Extract measurement unit data from array (API returns it as an array from lookup)
              const measurementUnit =
                item.measurementUnitData && item.measurementUnitData.length > 0
                  ? item.measurementUnitData[0]
                  : null;
              const measurementUnitSymbol = measurementUnit
                ? measurementUnit.representationSymbol || '-'
                : '-';
              const measurementUnitMongoId = measurementUnit ? measurementUnit._id || '' : '';

              // API doesn't return averagePrice (it's commented out in the aggregation)
              // But we still display it as 0.00 or use it if present
              const averagePrice = item.averagePrice
                ? parseFloat(item.averagePrice).toFixed(2)
                : '0.00';

              return `
            <tr>
              <td>${escapeHtml(item.fullCode || '-')}</td>
              <td>${escapeHtml(item.name || '-')}</td>
              <td>${item.laborHours || '-'}</td>
              <td>${escapeHtml(measurementUnitSymbol)}</td>
              <td>${averagePrice}</td>
              <td>
                <button class="btn btn-primary" style="padding: 4px 12px; font-size: 13px;" onclick="selectLaborItem('${
                  item._id
                }', '${escapeHtml(item.name || '')}', '${escapeHtml(
                measurementUnitSymbol
              )}', '${measurementUnitMongoId}', '${item.averagePrice || 0}', '${
                item.laborHours || 0
              }')">
                  ‚ûï Add
                </button>
              </td>
            </tr>
          `;
            })
            .join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('Error loading labor items:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading items: ${error.message}</div>`;
  }
}

function searchLaborCategoriesInDialog() {
  const searchVal = document.getElementById('addLaborSearchInput')?.value || '';
  expandedLaborAccordions.clear();
  loadLaborCategoriesForDialog(searchVal);
}

// Select labor item and open details dialog
function selectLaborItem(itemId, itemName, unitSymbol, unitId, averagePrice, laborHours) {
  console.log('selectLaborItem called with:', {
    itemId,
    itemName,
    unitSymbol,
    unitId,
    averagePrice,
    laborHours,
  });

  // Ensure itemId and unitId are strings (they come from the table)
  selectedLaborItemData = {
    itemId: String(itemId),
    itemName: String(itemName || ''),
    unitSymbol: String(unitSymbol || ''),
    unitId: String(unitId || ''),
    averagePrice: parseFloat(averagePrice) || 0,
    laborHours: parseFloat(laborHours) || 0,
  };

  console.log('Selected labor item data:', selectedLaborItemData);

  // Update details dialog - only show quantity field (matching production)
  const nameElement = document.getElementById('selectedLaborItemName');
  const unitElement = document.getElementById('selectedLaborUnit');
  const quantityInput = document.getElementById('addLaborQuantityInput');

  if (nameElement) nameElement.textContent = itemName || '-';
  if (unitElement) unitElement.textContent = unitSymbol || '-';
  if (quantityInput) {
    quantityInput.value = '';
    quantityInput.focus(); // Focus on quantity input for quick entry
  }

  // Close selection dialog and open details dialog
  // Don't clear section/subsection IDs - we need them for the API call
  closeAddLaborModal();
  // Small delay to ensure modal closes before opening next one
  setTimeout(() => {
    openAddLaborDetailsModal();
  }, 100);
}

// Open Add Labor Details Modal
function openAddLaborDetailsModal() {
  const modal = document.getElementById('addLaborDetailsModal');
  if (modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Focus on quantity input
    const quantityInput = document.getElementById('addLaborQuantityInput');
    if (quantityInput) {
      quantityInput.focus();
    }
  }
}

function closeAddLaborDetailsModal() {
  const modal = document.getElementById('addLaborDetailsModal');
  if (modal) {
    modal.classList.add('hidden');
    // Clear all data when closing the details modal (user cancelled or completed)
    selectedLaborItemData = null;
    currentAddLaborSubsectionId = null;
    currentAddLaborSectionId = null;
    document.body.style.overflow = 'auto';
  }
}

// Confirm and add labor item
async function confirmAddLaborItem() {
  console.log('confirmAddLaborItem called');
  console.log('selectedLaborItemData:', selectedLaborItemData);
  console.log('currentAddLaborSubsectionId:', currentAddLaborSubsectionId);
  console.log('currentAddLaborSectionId:', currentAddLaborSectionId);
  console.log('currentEstimateId:', currentEstimateId);

  if (!selectedLaborItemData || (!currentAddLaborSubsectionId && !currentAddLaborSectionId)) {
    console.error('Missing required data:', {
      selectedLaborItemData: !!selectedLaborItemData,
      subsectionId: !!currentAddLaborSubsectionId,
      sectionId: !!currentAddLaborSectionId,
    });
    showAlert('Please select a labor item and section/subsection', 'error', 'dashboardAlert');
    return;
  }

  if (!currentEstimateId) {
    console.error('No current estimate ID');
    showAlert('No estimate selected', 'error', 'dashboardAlert');
    return;
  }

  const quantityInput = document.getElementById('addLaborQuantityInput');
  // Production allows quantity to be 0 or empty, defaults to '0'
  const quantityString = quantityInput?.value?.trim() || '0';

  console.log('Quantity:', quantityString);

  if (!selectedLaborItemData.unitId) {
    console.error('Missing unitId');
    showAlert('Unit information is missing', 'error', 'dashboardAlert');
    return;
  }

  if (!selectedLaborItemData.itemId) {
    console.error('Missing itemId');
    showAlert('Labor item ID is missing', 'error', 'dashboardAlert');
    return;
  }

  try {
    // API uses getReqParam/requireQueryParam which reads from query params OR body
    // Production sends args as query params, so we'll do the same
    const queryParams = {};

    if (currentAddLaborSubsectionId) {
      queryParams.estimateSubsectionId = String(currentAddLaborSubsectionId);
    } else if (currentAddLaborSectionId) {
      queryParams.estimateSectionId = String(currentAddLaborSectionId);
    } else {
      showAlert('Invalid section/subsection', 'error', 'dashboardAlert');
      return;
    }

    // Required parameters matching production - all as strings
    queryParams.laborItemId = String(selectedLaborItemData.itemId);
    queryParams.laborItemQuantity = quantityString; // Can be '0' if empty (matching production)
    queryParams.laborOffersAveragePrice = (selectedLaborItemData.averagePrice || 0).toString();
    queryParams.laborOfferItemLaborHours = (selectedLaborItemData.laborHours || 0).toString();
    queryParams.laborItemMeasurementUnitMongoId = String(selectedLaborItemData.unitId);
    queryParams.laborOfferItemName = String(selectedLaborItemData.itemName || '');

    console.log('Adding labor item with query params:', queryParams);
    console.log(
      'Request URL will be: /api/v1/estimate/add_labor_item?' +
        new URLSearchParams(queryParams).toString()
    );

    // API expects query params (not body) for getReqParam/requireQueryParam
    // Production uses POST with query params
    const response = await makeRequest(
      'POST',
      '/api/v1/estimate/add_labor_item',
      null,
      queryParams
    );

    console.log('API response:', response);

    closeAddLaborDetailsModal();

    // Reload estimate details to show the new labor item
    if (currentEstimateId) {
      console.log('Reloading estimate details for ID:', currentEstimateId);
      await loadEstimateDetails(currentEstimateId);
    }

    showAlert('Labor item added successfully', 'success', 'dashboardAlert');
  } catch (error) {
    console.error('Error adding labor item:', error);
    console.error('Error stack:', error.stack);
    showAlert(`Error adding labor item: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// ==================== MATERIAL ADDITION FUNCTIONS ====================

// Open Add Material Dialog for a specific labor item
async function openAddMaterialDialogForLabor(laborId, laborName) {
  console.log('openAddMaterialDialogForLabor called with:', {
    laborId,
    laborName,
  });

  // Store the labor ID for later use when confirming
  currentAddMaterialLaborId = String(laborId);
  selectedMaterialItemData = null;
  expandedMaterialAccordions.clear();

  const modal = document.getElementById('addMaterialModal');
  if (modal) {
    // Check if materials modal is open - if so, set higher z-index and make background transparent
    const materialsModal = document.getElementById('materialsModal');
    const backdrop = modal.querySelector('.modal-backdrop');

    const modalContent = modal.querySelector('.modal-content');

    if (materialsModal && !materialsModal.classList.contains('hidden')) {
      // Materials modal is open - set higher z-index for add material modal
      modal.style.zIndex = '3000'; // Higher than materials modal (2000)
      // Make modal background transparent so it doesn't cover materials modal
      modal.style.background = 'transparent';
      // Ensure modal content is above everything
      if (modalContent) {
        modalContent.style.zIndex = '3001';
        modalContent.style.position = 'relative';
      }
      // Hide backdrop so it doesn't cover materials modal and interfere
      if (backdrop) {
        backdrop.style.display = 'none';
      }
    } else {
      // Materials modal is not open - use default z-index and show backdrop
      modal.style.zIndex = '';
      modal.style.background = ''; // Reset to default (rgba(0, 0, 0, 0.5))
      if (modalContent) {
        modalContent.style.zIndex = '';
      }
      if (backdrop) {
        backdrop.style.display = '';
      }
    }

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Load material categories
    await loadMaterialCategoriesForDialog('');
  } else {
    console.error('Add material modal not found!');
  }
}

// Handle clicks on add material modal - don't close if materials modal is open
function handleAddMaterialModalClick(event) {
  // Only close if clicking directly on the modal div (not on children) and materials modal is not open
  if (event.target.id === 'addMaterialModal') {
    const materialsModal = document.getElementById('materialsModal');
    if (materialsModal && !materialsModal.classList.contains('hidden')) {
      // Materials modal is open - don't close add material modal
      return;
    }
    closeAddMaterialModal();
  }
}

// Handle clicks on backdrop - don't close if materials modal is open
function handleAddMaterialModalBackdropClick(event) {
  const materialsModal = document.getElementById('materialsModal');
  if (materialsModal && !materialsModal.classList.contains('hidden')) {
    // Materials modal is open - don't close add material modal
    return;
  }
  closeAddMaterialModal();
}

function closeAddMaterialModal() {
  const modal = document.getElementById('addMaterialModal');
  if (modal) {
    modal.classList.add('hidden');
    // Reset z-index to default
    modal.style.zIndex = '';
    // Reset background to default
    modal.style.background = '';
    // Reset modal content z-index
    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) {
      modalContent.style.zIndex = '';
    }
    // Reset backdrop display
    const backdrop = modal.querySelector('.modal-backdrop');
    if (backdrop) {
      backdrop.style.display = '';
    }
    // Don't clear labor ID here - we need it for the details modal
    expandedMaterialAccordions.clear();
    // Don't restore body overflow - details modal will handle it
  }
}

// Load material categories (Level 1)
async function loadMaterialCategoriesForDialog(searchVal = '') {
  const container = document.getElementById('addMaterialCategoriesAccordion');
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading material categories...</div>';

    // Production uses POST with args (query params) and json (body)
    // args: { searchVal }
    // json: { categoryId: null, subcategoryId: null, accountId: null }
    const queryParams = {};
    if (searchVal) {
      queryParams.searchVal = searchVal;
    }

    // Body with filters (matching production exactly)
    const requestBody = {
      categoryId: null,
      subcategoryId: null,
      accountId: null,
    };

    const response = await makeRequest(
      'POST',
      '/api/v1/material/fetch_categories',
      requestBody,
      queryParams
    );

    materialCategoriesData = Array.isArray(response) ? response : [];

    console.log('Material categories loaded:', materialCategoriesData.length, 'categories');

    if (materialCategoriesData.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No material categories found</div>';
      return;
    }

    // Render categories accordion
    container.innerHTML = materialCategoriesData
      .map(
        (cat) => `
      <div class="estimate-accordion" style="margin-bottom: 8px;">
        <div 
          class="estimate-accordion-header" 
          onclick="toggleMaterialCategory('${cat._id}')"
          style="cursor: pointer; padding: 10px 14px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;"
        >
          <span><strong>${escapeHtml(cat.code || '')}</strong> ${escapeHtml(cat.name || '-')} ${
          cat.childrenQuantity ? `(${cat.childrenQuantity})` : '(0)'
        }</span>
          <span style="font-size: 16px;">${
            expandedMaterialAccordions.has(`matcat-${cat._id}`) ? '‚ñº' : '‚ñ∂'
          }</span>
        </div>
        <div 
          id="matcat-${cat._id}-content" 
          class="estimate-accordion-content" 
          style="display: ${
            expandedMaterialAccordions.has(`matcat-${cat._id}`) ? 'block' : 'none'
          }; padding: 12px 16px; border-left: 2px solid #ddd; margin-left: 12px; margin-top: 8px;"
        >
          <div id="matcat-${
            cat._id
          }-subcategories" class="loading">Click to load subcategories...</div>
        </div>
      </div>
    `
      )
      .join('');
  } catch (error) {
    console.error('Error loading material categories:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading categories: ${error.message}</div>`;
  }
}

// Toggle material category (expand/collapse to load subcategories)
async function toggleMaterialCategory(categoryId) {
  console.log('toggleMaterialCategory called with:', categoryId, 'type:', typeof categoryId);
  const accordionId = `matcat-${categoryId}`;
  const isExpanded = expandedMaterialAccordions.has(accordionId);

  // Update expanded state first
  if (isExpanded) {
    expandedMaterialAccordions.delete(accordionId);
  } else {
    expandedMaterialAccordions.add(accordionId);
  }

  // Update UI visibility BEFORE loading subcategories
  const content = document.getElementById(`${accordionId}-content`);
  if (content) {
    content.style.display = expandedMaterialAccordions.has(accordionId) ? 'block' : 'none';
  }

  // Update icon
  const header = document.querySelector(`[onclick*="toggleMaterialCategory('${categoryId}')"]`);
  if (header) {
    const icon = header.querySelector('span:last-child');
    if (icon) {
      icon.textContent = expandedMaterialAccordions.has(accordionId) ? '‚ñº' : '‚ñ∂';
    }
  }

  // Load subcategories only if expanding
  if (expandedMaterialAccordions.has(accordionId)) {
    const categoryIdStr = String(categoryId);
    console.log('Loading subcategories for material category:', categoryIdStr);
    await loadMaterialSubcategories(categoryIdStr);
  }
}

// Load material subcategories (Level 2)
async function loadMaterialSubcategories(categoryId) {
  const container = document.getElementById(`matcat-${categoryId}-subcategories`);
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading subcategories...</div>';

    // Production API call: searchVal='' (empty string) and body: {"categoryId":null,"subcategoryId":null}
    const queryParams = {
      categoryMongoId: String(categoryId),
      searchVal: '', // Empty string - matching production exactly
    };

    // Pass body with categoryId and subcategoryId as null (matching production exactly)
    const requestBody = {
      categoryId: null,
      subcategoryId: null,
    };

    const response = await makeRequest(
      'POST',
      '/api/v1/material/fetch_subcategories',
      requestBody,
      queryParams
    );

    console.log('Material subcategories API call:', {
      categoryId,
      queryParams,
      responseType: typeof response,
      isArray: Array.isArray(response),
      responseLength: Array.isArray(response) ? response.length : 'N/A',
    });

    if (!response) {
      console.error('Empty response from subcategories API');
      container.innerHTML =
        '<div style="padding: 8px; color: #d32f2f;">Error: Empty response from server</div>';
      return;
    }

    const subcategories = Array.isArray(response) ? response : [];

    console.log('Parsed subcategories:', subcategories.length, 'items');

    if (subcategories.length === 0) {
      container.innerHTML = '<div style="padding: 8px; color: #666;">No subcategories found</div>';
      return;
    }

    // Render subcategories accordion
    container.innerHTML = subcategories
      .map(
        (subcat) => `
      <div class="estimate-accordion" style="margin-bottom: 8px;">
        <div 
          class="estimate-accordion-header" 
          onclick="toggleMaterialSubcategory('${categoryId}', '${subcat._id}')"
          style="cursor: pointer; padding: 10px 14px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;"
        >
          <span><strong>${escapeHtml(subcat.code || '')}</strong> ${escapeHtml(
          subcat.name || '-'
        )} ${subcat.childrenQuantity ? `(${subcat.childrenQuantity})` : '(0)'}</span>
          <span style="font-size: 16px;">${
            expandedMaterialAccordions.has(`matsubcat-${subcat._id}`) ? '‚ñº' : '‚ñ∂'
          }</span>
        </div>
        <div 
          id="matsubcat-${subcat._id}-content" 
          class="estimate-accordion-content" 
          style="display: ${
            expandedMaterialAccordions.has(`matsubcat-${subcat._id}`) ? 'block' : 'none'
          }; padding: 12px 16px; border-left: 2px solid #ddd; margin-left: 12px; margin-top: 8px;"
        >
          <div id="matsubcat-${subcat._id}-items" class="loading">Loading items...</div>
        </div>
      </div>
    `
      )
      .join('');
  } catch (error) {
    console.error('Error loading material subcategories:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading subcategories: ${error.message}</div>`;
  }
}

// Toggle material subcategory (expand/collapse to load items)
async function toggleMaterialSubcategory(categoryId, subcategoryId) {
  const accordionId = `matsubcat-${subcategoryId}`;
  const isExpanded = expandedMaterialAccordions.has(accordionId);

  // Update expanded state first
  if (isExpanded) {
    expandedMaterialAccordions.delete(accordionId);
  } else {
    expandedMaterialAccordions.add(accordionId);
  }

  // Update UI visibility BEFORE loading items
  const content = document.getElementById(`${accordionId}-content`);
  if (content) {
    content.style.display = expandedMaterialAccordions.has(accordionId) ? 'block' : 'none';
  }

  // Update icon
  const header = document.querySelector(
    `[onclick*="toggleMaterialSubcategory('${categoryId}', '${subcategoryId}')"]`
  );
  if (header) {
    const icon = header.querySelector('span:last-child');
    if (icon) {
      icon.textContent = expandedMaterialAccordions.has(accordionId) ? '‚ñº' : '‚ñ∂';
    }
  }

  // Load items only if expanding
  if (expandedMaterialAccordions.has(accordionId)) {
    await loadMaterialItems(subcategoryId);
  }
}

// Load material items (Level 3) - show as table
async function loadMaterialItems(subcategoryId) {
  const container = document.getElementById(`matsubcat-${subcategoryId}-items`);
  if (!container) return;

  try {
    container.innerHTML = '<div class="loading">Loading items...</div>';

    // Production uses GET request with query params: subcategoryMongoId, searchVal (empty), isSorting, calledFromPage
    const queryParams = {
      subcategoryMongoId: String(subcategoryId),
      searchVal: '', // Empty string - matching production exactly
      isSorting: 'true',
      calledFromPage: 'estCatAccordion',
    };

    // Production uses GET request (no body)
    const response = await makeRequest(
      'GET',
      '/api/v1/material/fetch_items_with_average_price',
      null,
      queryParams
    );

    console.log('Material items response for subcategory', subcategoryId, ':', response);

    const items = Array.isArray(response) ? response : [];

    if (items.length === 0) {
      container.innerHTML = '<div style="padding: 8px; color: #666;">No items found</div>';
      return;
    }

    // Render items table
    // API returns measurementUnitData as an array from lookup, need to extract first element
    container.innerHTML = `
      <table class="table" style="width: 100%;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Unit</th>
            <th>Average Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${items
            .map((item) => {
              // Extract measurement unit data from array (API returns it as an array from lookup)
              const measurementUnit =
                item.measurementUnitData && item.measurementUnitData.length > 0
                  ? item.measurementUnitData[0]
                  : null;
              const measurementUnitSymbol = measurementUnit
                ? measurementUnit.representationSymbol || '-'
                : '-';
              const measurementUnitMongoId = measurementUnit ? measurementUnit._id || '' : '';

              // API may or may not return averagePrice
              const averagePrice = item.averagePrice
                ? parseFloat(item.averagePrice).toFixed(2)
                : '0.00';

              return `
            <tr>
              <td>${escapeHtml(item.fullCode || '-')}</td>
              <td>${escapeHtml(item.name || '-')}</td>
              <td>${escapeHtml(measurementUnitSymbol)}</td>
              <td>${averagePrice}</td>
              <td>
                <button class="btn btn-primary" style="padding: 4px 12px; font-size: 13px;" onclick="selectMaterialItem('${
                  item._id
                }', '${escapeHtml(item.name || '')}', '${escapeHtml(
                measurementUnitSymbol
              )}', '${measurementUnitMongoId}', '${item.averagePrice || 0}')">
                  ‚ûï Add
                </button>
              </td>
            </tr>
          `;
            })
            .join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('Error loading material items:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading items: ${error.message}</div>`;
  }
}

function searchMaterialCategoriesInDialog() {
  const searchVal = document.getElementById('addMaterialSearchInput')?.value || '';
  expandedMaterialAccordions.clear();
  loadMaterialCategoriesForDialog(searchVal);
}

// Select material item and fetch offers (matching production)
async function selectMaterialItem(itemId, itemName, unitSymbol, unitId, averagePrice) {
  console.log('selectMaterialItem called with:', {
    itemId,
    itemName,
    unitSymbol,
    unitId,
    averagePrice,
  });

  // Ensure itemId and unitId are strings
  selectedMaterialItemData = {
    itemId: String(itemId),
    itemName: String(itemName || ''),
    unitSymbol: String(unitSymbol || ''),
    unitId: String(unitId || ''),
    averagePrice: parseFloat(averagePrice) || 0,
  };

  console.log('Selected material item data:', selectedMaterialItemData);

  // Close selection dialog first
  closeAddMaterialModal();

  // Fetch material offers before showing details (matching production)
  try {
    await fetchAndShowMaterialOffers(itemId, itemName);
  } catch (error) {
    console.error('Error fetching material offers:', error);
    showAlert(`Error fetching material offers: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// Fetch material offers and show offers modal (matching production)
async function fetchAndShowMaterialOffers(materialItemId, materialItemName) {
  const modalBody = document.getElementById('materialOffersModalBody');
  const modalTitle = document.getElementById('materialOffersModalTitle');

  if (!modalBody || !modalTitle) {
    console.error('Material offers modal elements not found');
    return;
  }

  // Show modal with loading state
  const modal = document.getElementById('addMaterialOffersModal');
  if (modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    modalTitle.textContent = `Material Offers: ${materialItemName || '-'}`;
    modalBody.innerHTML = '<div class="loading">Loading offers...</div>';
  }

  try {
    // Production uses GET request with materialItemId as query parameter
    const queryParams = {
      materialItemId: String(materialItemId),
    };

    const response = await makeRequest(
      'GET',
      '/api/v1/estimate/fetch_material_offers',
      null,
      queryParams
    );

    console.log('Material offers response:', response);

    // API returns an array where first element has { offers: [], averagePrice: number }
    if (
      !response ||
      !Array.isArray(response) ||
      response.length === 0 ||
      !response[0].offers ||
      response[0].offers.length === 0
    ) {
      // No offers - show alert and open details dialog directly (matching production behavior)
      closeAddMaterialOffersModal();
      showAlert('No offers found for this material item', 'info', 'dashboardAlert');
      // Still allow adding without offers
      setTimeout(() => {
        openAddMaterialDetailsModal();
      }, 100);
      return;
    }

    const offersData = response[0];
    const offers = offersData.offers || [];
    const averagePrice = offersData.averagePrice || 0;

    console.log('Material offers:', offers);
    console.log('Average price:', averagePrice);

    // Store average price for later use
    selectedMaterialItemData.averagePrice = averagePrice;

    // Render offers table (matching production: Company, Unit, Price, Date, Action)
    modalBody.innerHTML = `
      <div style="margin-bottom: 16px;">
        <strong>Average Price: ${averagePrice.toFixed(3)}</strong>
      </div>
      <table class="table" style="width: 100%;">
        <thead>
          <tr>
            <th>Company</th>
            <th>Unit</th>
            <th>Price</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${offers
            .map((offer) => {
              const accountName = offer.accountMadeOfferData?.companyName || '-';
              const unitSymbol = offer.measurementUnitData?.[0]?.representationSymbol || '-';
              const price = offer.price ? parseFloat(offer.price).toFixed(2) : '0.00';
              // Format date as DD.MM.YYYY HH:mm (matching production)
              const updatedAt = offer.updatedAt
                ? (() => {
                    const date = new Date(offer.updatedAt);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${day}.${month}.${year} ${hours}:${minutes}`;
                  })()
                : '-';
              const offerId = offer._id || '';

              return `
                <tr>
                  <td>${escapeHtml(accountName)}</td>
                  <td>${escapeHtml(unitSymbol)}</td>
                  <td>${price}</td>
                  <td>${updatedAt}</td>
                  <td>
                    <button class="btn btn-primary" style="padding: 4px 12px; font-size: 13px;" onclick="selectMaterialOffer('${offerId}', '${price}', '${escapeHtml(
                accountName
              )}')">
                      ‚ûï Select
                    </button>
                  </td>
                </tr>
              `;
            })
            .join('')}
        </tbody>
      </table>
    `;
  } catch (error) {
    console.error('Error fetching material offers:', error);
    modalBody.innerHTML = `<div class="alert alert-error">Error loading offers: ${error.message}</div>`;
  }
}

// Select a material offer and open details dialog
function selectMaterialOffer(offerId, offerPrice, accountName) {
  console.log('selectMaterialOffer called with:', {
    offerId,
    offerPrice,
    accountName,
  });

  // Store selected offer data
  selectedMaterialItemData.selectedOfferId = String(offerId);
  selectedMaterialItemData.selectedOfferPrice =
    parseFloat(offerPrice) || selectedMaterialItemData.averagePrice;

  // Close offers modal and open details modal
  closeAddMaterialOffersModal();
  setTimeout(() => {
    openAddMaterialDetailsModal();
  }, 100);
}

// Open Add Material Offers Modal
function openAddMaterialOffersModal() {
  const modal = document.getElementById('addMaterialOffersModal');
  if (modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
}

function closeAddMaterialOffersModal() {
  const modal = document.getElementById('addMaterialOffersModal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  }
}

// Open Add Material Details Modal
function openAddMaterialDetailsModal() {
  const modal = document.getElementById('addMaterialDetailsModal');
  if (modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Update fields with selected material item data
    if (selectedMaterialItemData) {
      const nameElement = document.getElementById('selectedMaterialItemName');
      const unitElement = document.getElementById('selectedMaterialUnit');
      const consumptionNormInput = document.getElementById('addMaterialConsumptionNormInput');

      if (nameElement) nameElement.textContent = selectedMaterialItemData.itemName || '-';
      if (unitElement) unitElement.textContent = selectedMaterialItemData.unitSymbol || '-';
      if (consumptionNormInput) {
        consumptionNormInput.value = '';
        consumptionNormInput.focus(); // Focus on consumption norm input for quick entry
      }
    }

    // Focus on consumption norm input
    const consumptionNormInput = document.getElementById('addMaterialConsumptionNormInput');
    if (consumptionNormInput) {
      consumptionNormInput.focus();
    }
  }
}

function closeAddMaterialDetailsModal() {
  const modal = document.getElementById('addMaterialDetailsModal');
  if (modal) {
    modal.classList.add('hidden');
    // Clear all data when closing the details modal (user cancelled or completed)
    selectedMaterialItemData = null;
    currentAddMaterialLaborId = null;
    document.body.style.overflow = 'auto';
  }
}

// Confirm and add material item
async function confirmAddMaterialItem() {
  console.log('confirmAddMaterialItem called');
  console.log('selectedMaterialItemData:', selectedMaterialItemData);
  console.log('currentAddMaterialLaborId:', currentAddMaterialLaborId);
  console.log('currentEstimateId:', currentEstimateId);

  if (!selectedMaterialItemData || !currentAddMaterialLaborId) {
    console.error('Missing required data:', {
      selectedMaterialItemData: !!selectedMaterialItemData,
      laborId: !!currentAddMaterialLaborId,
    });
    showAlert('Please select a material item and labor item', 'error', 'dashboardAlert');
    return;
  }

  if (!currentEstimateId) {
    console.error('No current estimate ID');
    showAlert('No estimate selected', 'error', 'dashboardAlert');
    return;
  }

  const consumptionNormInput = document.getElementById('addMaterialConsumptionNormInput');
  // Production allows consumption norm to be 0 or empty, defaults to '0'
  const consumptionNormString = consumptionNormInput?.value?.trim() || '0';

  console.log('Material consumption norm:', consumptionNormString);

  if (!selectedMaterialItemData.unitId) {
    console.error('Missing unitId');
    showAlert('Unit information is missing', 'error', 'dashboardAlert');
    return;
  }

  if (!selectedMaterialItemData.itemId) {
    console.error('Missing itemId');
    showAlert('Material item ID is missing', 'error', 'dashboardAlert');
    return;
  }

  try {
    // API uses getReqParam/requireQueryParam which reads from query params OR body
    // Production sends args as query params
    // Use selected offer price if available, otherwise use average price
    const priceToUse =
      selectedMaterialItemData.selectedOfferPrice !== undefined
        ? selectedMaterialItemData.selectedOfferPrice
        : selectedMaterialItemData.averagePrice || 0;

    const queryParams = {
      estimatedLaborId: String(currentAddMaterialLaborId),
      materialItemId: String(selectedMaterialItemData.itemId),
      materialItemMeasurementUnitMongoId: String(selectedMaterialItemData.unitId),
      materialOfferItemName: String(selectedMaterialItemData.itemName || ''),
      materialConsumptionNorm: consumptionNormString, // Can be '0' if empty (matching production)
      materialOffersAveragePrice: priceToUse.toString(),
    };

    // Add offer ID if a specific offer was selected (optional parameter)
    if (selectedMaterialItemData.selectedOfferId) {
      queryParams.materialOfferId = String(selectedMaterialItemData.selectedOfferId);
    }

    console.log('Adding material item with query params:', queryParams);
    console.log(
      'Request URL will be: /api/v1/estimate/add_material_item?' +
        new URLSearchParams(queryParams).toString()
    );

    // API expects query params for getReqParam/requireQueryParam
    // Production uses POST with query params
    const response = await makeRequest(
      'POST',
      '/api/v1/estimate/add_material_item',
      null,
      queryParams
    );

    console.log('API response:', response);

    // Save values before closing modal (in case closeAddMaterialDetailsModal clears anything)
    const shouldReopenMaterialsModal =
      wasMaterialsModalOpen && savedMaterialsLaborId && savedMaterialsLaborName;
    const laborIdToReopen = savedMaterialsLaborId;
    const laborNameToReopen = savedMaterialsLaborName;

    closeAddMaterialDetailsModal();

    // Reload estimate details to show the new material item
    if (currentEstimateId) {
      console.log('Reloading estimate details for ID:', currentEstimateId);
      await loadEstimateDetails(currentEstimateId);
    }

    // If materials modal was open before adding, refresh it with the new material
    if (shouldReopenMaterialsModal && laborIdToReopen && laborNameToReopen) {
      console.log('Refreshing materials modal with:', {
        laborId: laborIdToReopen,
        laborName: laborNameToReopen,
      });
      wasMaterialsModalOpen = false; // Reset flag
      savedMaterialsLaborId = null; // Reset saved ID
      savedMaterialsLaborName = null; // Reset saved name

      // Check if materials modal is still open (it should be)
      const materialsModal = document.getElementById('materialsModal');
      if (materialsModal && !materialsModal.classList.contains('hidden')) {
        // Materials modal is still open - just refresh it with new materials list
        await loadMaterials(laborIdToReopen);
      } else {
        // Materials modal was closed somehow - reopen it
        setTimeout(async () => {
          await openMaterialsDialog(laborIdToReopen, laborNameToReopen);
        }, 200);
      }
    } else if (currentAddMaterialLaborId) {
      // If materials modal wasn't explicitly tracked but is visible, refresh it
      const materialsModal = document.getElementById('materialsModal');
      if (
        materialsModal &&
        !materialsModal.classList.contains('hidden') &&
        currentMaterialsLaborId
      ) {
        // Reload materials list to show newly added material
        await loadMaterials(currentMaterialsLaborId);
      }
    }

    showAlert('Material item added successfully', 'success', 'dashboardAlert');
  } catch (error) {
    console.error('Error adding material item:', error);
    console.error('Error stack:', error.stack);
    showAlert(`Error adding material item: ${error.message}`, 'error', 'dashboardAlert');
  }
}

// ==================== END MATERIAL ADDITION FUNCTIONS ====================

// Tabs (for account page tabs)
function showTab(tab) {
  console.log('showTab called with:', tab);
  // Hide all tab panes in the account page by adding hidden class and setting display
  document.querySelectorAll('#page-account .tab-pane').forEach((p) => {
    p.classList.add('hidden');
    p.style.display = 'none';
  });
  // Show selected tab pane by removing hidden class and setting display
  const targetPane = document.getElementById(`tab-content-${tab}`);
  if (targetPane) {
    targetPane.classList.remove('hidden');
    targetPane.style.display = 'block';
    console.log('Showing tab-pane:', targetPane.id, 'Classes:', targetPane.className);
  } else {
    console.error('Tab pane not found:', `tab-content-${tab}`);
  }

  // Update tab buttons in the account page
  document.querySelectorAll('#page-account .tab').forEach((t) => t.classList.remove('active'));
  const targetTab = document.getElementById(`tab-${tab}`);
  if (targetTab) {
    targetTab.classList.add('active');
  }
}

// Load Dashboard
async function loadDashboard() {
  const container = document.getElementById('dashboardStats');
  if (!isAuthenticated) {
    container.innerHTML = '<div class="loading">Please sign in to view dashboard</div>';
    return;
  }

  container.innerHTML = '<div class="loading">Loading dashboard data...</div>';

  try {
    const response = await fetch(`${getBackendUrl()}/api/v1/dashboard/fetch_data`, {
      method: 'GET',
      credentials: 'include',
    });

    if (!response.ok) {
      const errorText = await response.text();
      container.innerHTML = `<div class="alert alert-error">Failed to load dashboard (${response.status}): ${errorText}</div>`;
      return;
    }

    const data = await response.json();
    console.log('Dashboard data:', data);

    // Handle different possible response structures
    let dashboardStats = [];
    if (data && data.dashboard && Array.isArray(data.dashboard)) {
      dashboardStats = data.dashboard;
    } else if (data && Array.isArray(data)) {
      dashboardStats = data;
    } else if (data && typeof data === 'object') {
      // Try to find any array in the response
      Object.keys(data).forEach((key) => {
        if (Array.isArray(data[key])) {
          dashboardStats = data[key];
        }
      });
    }

    if (dashboardStats.length > 0) {
      container.innerHTML = dashboardStats
        .map(
          (stat) => `
        <div class="stat-card">
          <h3>${escapeHtml(stat.title || stat.name || 'Stat')}</h3>
          <div class="count ${stat.hasPending ? 'pending' : ''}">${escapeHtml(
            String(stat.count || stat.value || '0')
          )}</div>
        </div>
      `
        )
        .join('');
    } else {
      container.innerHTML =
        '<div class="alert alert-error">No dashboard data available. Response structure: ' +
        escapeHtml(JSON.stringify(data, null, 2)) +
        '</div>';
    }
  } catch (error) {
    console.error('Dashboard load error:', error);
    container.innerHTML = `<div class="alert alert-error">Error loading dashboard: ${error.message}</div>`;
  }
}

// Load Account Data
async function loadAccountData() {
  if (!isAuthenticated) {
    const accountInfo = document.getElementById('accountInfo');
    if (accountInfo) {
      accountInfo.innerHTML =
        '<div class="alert alert-error">Please sign in to view account information</div>';
    }
    return;
  }

  const accountInfo = document.getElementById('accountInfo');
  if (!accountInfo) {
    console.error('Account info element not found');
    return;
  }

  accountInfo.innerHTML = '<div class="loading">Loading account information...</div>';

  try {
    const response = await fetch(`${getBackendUrl()}/api/v1/profile/get_account`, {
      method: 'GET',
      credentials: 'include',
    });

    if (!response.ok) {
      const errorText = await response.text();
      accountInfo.innerHTML = `<div class="alert alert-error">Failed to load account (${response.status}): ${errorText}</div>`;
      return;
    }

    accountData = await response.json();
    console.log('Account data:', accountData);
    console.log('Account data keys:', Object.keys(accountData));

    if (accountData && Object.keys(accountData).length > 0) {
      await renderAccountInfo();
    } else {
      accountInfo.innerHTML =
        '<div class="alert alert-error">No account data received. Response: ' +
        JSON.stringify(accountData) +
        '</div>';
    }
  } catch (error) {
    console.error('Error loading account data:', error);
    accountInfo.innerHTML = `<div class="alert alert-error">Error loading account information: ${error.message}</div>`;
  }
}

async function renderAccountInfo() {
  if (!accountData) {
    console.error('No account data to render');
    return;
  }

  console.log('Rendering account info:', accountData);
  console.log('Account data keys:', Object.keys(accountData));

  // First, ensure main app is visible
  const mainApp = document.getElementById('mainApp');
  if (mainApp && mainApp.classList.contains('hidden')) {
    console.log('Main app is hidden, showing it...');
    mainApp.classList.remove('hidden');
  }

  // Ensure we're on the account page
  const accountPage = document.getElementById('page-account');
  if (!accountPage) {
    console.error('‚ùå Account page element not found!');
    return;
  }

  // Force account page to be visible
  accountPage.classList.add('active');
  accountPage.style.display = 'block';
  document.querySelectorAll('.page').forEach((p) => {
    if (p !== accountPage) {
      p.classList.remove('active');
      p.style.display = 'none';
    }
  });

  console.log('Account page is active?', accountPage.classList.contains('active'));
  console.log('Account page computed display:', window.getComputedStyle(accountPage).display);

  // Ensure the aboutCompany tab is visible when rendering
  const tabContent = document.getElementById('tab-content-aboutCompany');
  if (!tabContent) {
    console.error('‚ùå tab-content-aboutCompany element not found!');
    return;
  }

  // Explicitly show the tab
  showTab('aboutCompany');

  // Force visibility with multiple methods
  tabContent.classList.remove('hidden');
  tabContent.style.display = 'block';
  tabContent.style.visibility = 'visible';
  tabContent.style.opacity = '1';

  // Ensure parent is visible too
  const tabContentParent = tabContent.parentElement;
  if (tabContentParent) {
    tabContentParent.style.display = 'block';
    tabContentParent.style.visibility = 'visible';
  }

  console.log('Tab content visibility ensured:');
  console.log('  - Hidden class?', tabContent.classList.contains('hidden'));
  console.log('  - Style display:', tabContent.style.display);
  console.log('  - Computed display:', window.getComputedStyle(tabContent).display);
  console.log('  - Offset parent (visible)?', tabContent.offsetParent !== null);

  // Update company header (these should always exist)
  const companyNameEl = document.getElementById('companyName');
  const companyLogoEl = document.getElementById('companyLogo');
  if (companyNameEl) {
    companyNameEl.textContent = accountData.companyName || 'No Company Name';
    console.log('Updated company name:', accountData.companyName);
  } else {
    console.error('companyName element not found!');
  }
  if (companyLogoEl && accountData.companyName) {
    companyLogoEl.textContent = accountData.companyName.charAt(0).toUpperCase();
  }

  // Wait a moment to ensure DOM is ready
  await new Promise((resolve) => setTimeout(resolve, 100));

  // Render account form - find the element directly
  let accountInfo = document.getElementById('accountInfo');
  if (!accountInfo) {
    console.error('Account info element not found, creating it...');
    accountInfo = document.createElement('div');
    accountInfo.id = 'accountInfo';
    accountInfo.style.display = 'block';
    accountInfo.style.visibility = 'visible';
    tabContent.innerHTML = '';
    tabContent.appendChild(accountInfo);
  }

  // Force visibility on accountInfo element
  accountInfo.style.display = 'block';
  accountInfo.style.visibility = 'visible';
  accountInfo.style.opacity = '1';

  console.log('Found accountInfo element:', accountInfo);
  console.log('AccountInfo parent:', accountInfo.parentElement?.id);
  console.log('AccountInfo is in DOM?', document.body.contains(accountInfo));
  console.log('Tab content classes:', tabContent.className);
  console.log('Tab content is hidden?', tabContent.classList.contains('hidden'));
  console.log('Tab content display:', window.getComputedStyle(tabContent).display);

  // Test with simple HTML first
  accountInfo.innerHTML =
    '<div style="background: #4CAF50; color: white; padding: 20px; margin: 20px; border-radius: 8px; font-size: 18px;">‚úÖ TEST: Element is working! Data received. Rendering now...</div>';
  await new Promise((resolve) => setTimeout(resolve, 200));
  console.log('Test HTML set. AccountInfo innerHTML length:', accountInfo.innerHTML.length);
  console.log('AccountInfo visible?', accountInfo.offsetParent !== null);

  // Format account activity
  let activityDisplay = '-';
  if (accountData.accountActivity) {
    if (Array.isArray(accountData.accountActivity)) {
      activityDisplay = accountData.accountActivity.join(', ');
    } else if (typeof accountData.accountActivity === 'string') {
      activityDisplay = accountData.accountActivity;
    }
  }

  // Escape all values for safety - handle null/undefined
  const safeWebsite = accountData.website ? escapeHtml(String(accountData.website)) : '';
  const safeCompanyName = escapeHtml(String(accountData.companyName || '-'));
  const safeEstablishedAt = escapeHtml(String(accountData.establishedAt || '-'));
  const safePhoneNumber = escapeHtml(String(accountData.phoneNumber || '-'));
  const safeCompanyTin = escapeHtml(String(accountData.companyTin || '-'));
  const safeEmail = escapeHtml(String(accountData.email || '-'));
  const safeAddress = escapeHtml(String(accountData.address || '-'));
  const safeLawAddress = escapeHtml(String(accountData.lawAddress || '-'));
  const safeDirector = escapeHtml(String(accountData.director || '-'));
  const safeCompanyInfo = escapeHtml(String(accountData.companyInfo || '-'));
  const safeActivityDisplay = escapeHtml(String(activityDisplay));

  console.log('About to set innerHTML for accountInfo...');
  console.log('AccountInfo element exists?', !!accountInfo);
  console.log('AccountInfo element parent:', accountInfo.parentElement?.id);

  const htmlContent = `
    <div class="form-row">
      <div class="form-field">
        <label>Company Name</label>
        <div class="value">${safeCompanyName}</div>
      </div>
      <div class="form-field">
        <label>Establish Date</label>
        <div class="value">${safeEstablishedAt}</div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-field">
        <label>Phone Number</label>
        <div class="value">${safePhoneNumber}</div>
      </div>
      <div class="form-field">
        <label>TIN</label>
        <div class="value">${safeCompanyTin}</div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-field">
        <label>Activity</label>
        <div class="value">${safeActivityDisplay}</div>
      </div>
      <div class="form-field">
        <label>Email</label>
        <div class="value">${safeEmail}</div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-field">
        <label>Address</label>
        <div class="value">${safeAddress}</div>
      </div>
      <div class="form-field">
        <label>Legal Address</label>
        <div class="value">${safeLawAddress}</div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-field">
        <label>Website</label>
        <div class="value">${
          safeWebsite
            ? `<a href="${safeWebsite}" target="_blank" rel="noopener noreferrer">${safeWebsite}</a>`
            : '-'
        }</div>
      </div>
      <div class="form-field">
        <label>Director</label>
        <div class="value">${safeDirector}</div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-field full-width">
        <label>About Company</label>
        <div class="value">${safeCompanyInfo}</div>
      </div>
    </div>
  `;

  // Set the innerHTML with better error handling
  try {
    console.log('Setting innerHTML, content length:', htmlContent.length);

    // First, set a simple test to verify element works
    accountInfo.innerHTML =
      '<div style="background: #4CAF50; color: white; padding: 20px; margin: 20px; border-radius: 8px; font-size: 18px; font-weight: bold;">‚úÖ TEST: Element is working! Rendering account data...</div>';
    await new Promise((resolve) => setTimeout(resolve, 100));
    console.log('Test HTML set. Element visible?', accountInfo.offsetParent !== null);
    console.log('Test HTML length:', accountInfo.innerHTML.length);

    // Now set the real content
    accountInfo.innerHTML = htmlContent;

    console.log('‚úÖ innerHTML set successfully!');
    console.log('Content length:', accountInfo.innerHTML.length);
    console.log('First 500 chars:', accountInfo.innerHTML.substring(0, 500));

    // Force visibility one more time after setting content
    tabContent.style.display = 'block';
    tabContent.style.visibility = 'visible';
    accountInfo.style.display = 'block';
    accountInfo.style.visibility = 'visible';

    // Verify content is there
    if (
      !accountInfo.innerHTML ||
      accountInfo.innerHTML.length === 0 ||
      (accountInfo.innerHTML.trim && accountInfo.innerHTML.trim() === '')
    ) {
      console.error('‚ùå innerHTML is empty after setting! This should not happen.');
      accountInfo.innerHTML =
        '<div class="alert alert-error">Error: Content was cleared. This is a bug.</div>';
      return;
    }

    // Check visibility one more time
    setTimeout(() => {
      const computedDisplay = window.getComputedStyle(accountInfo).display;
      const isVisible = accountInfo.offsetParent !== null;
      console.log('After delay - AccountInfo display:', computedDisplay);
      console.log('After delay - AccountInfo visible?', isVisible);
      console.log('After delay - Content length:', accountInfo.innerHTML.length);

      if (!isVisible && accountInfo.innerHTML && accountInfo.innerHTML.length > 0) {
        console.error('‚ùå Content is set but element is not visible!');
        console.error('Forcing visibility with inline styles...');
        accountInfo.setAttribute(
          'style',
          'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 100px; background: white;'
        );
        tabContent.setAttribute(
          'style',
          'display: block !important; visibility: visible !important;'
        );
      }
    }, 500);
  } catch (err) {
    console.error('‚ùå Error setting innerHTML:', err);
    console.error('Error details:', err.message);
    console.error('Error stack:', err.stack);
    accountInfo.innerHTML = `<div class="alert alert-error">Error rendering HTML: ${
      err.message
    }<br>Stack: ${err.stack?.substring(0, 200)}</div>`;
    return;
  }

  // Force all parent containers to be visible
  const contentDiv = document.querySelector('.content');
  if (contentDiv) {
    contentDiv.style.display = 'block';
    contentDiv.style.visibility = 'visible';
  }

  // Ensure tab content container is visible
  const tabContentContainer = document.querySelector('.tab-content');
  if (tabContentContainer) {
    tabContentContainer.style.display = 'block';
    tabContentContainer.style.visibility = 'visible';
  }

  // Force visibility on all elements in the chain
  accountPage.style.display = 'block';
  accountPage.style.visibility = 'visible';
  tabContentContainer.style.display = 'block';
  tabContent.style.display = 'block';
  tabContent.style.visibility = 'visible';
  accountInfo.style.display = 'block';
  accountInfo.style.visibility = 'visible';

  // Remove hidden class from everything
  accountPage.classList.remove('hidden');
  tabContent.classList.remove('hidden');

  // Verify visibility
  console.log('Final visibility check:');
  console.log('  - Account page display:', window.getComputedStyle(accountPage).display);
  console.log('  - Tab content display:', window.getComputedStyle(tabContent).display);
  console.log('  - AccountInfo display:', window.getComputedStyle(accountInfo).display);
  console.log('  - AccountInfo has content?', accountInfo.innerHTML.length > 0);
  console.log('  - AccountInfo visible (offsetParent)?', accountInfo.offsetParent !== null);
}
